---
title: "HFD_make_evaluation_data"
author: "Quynh Tran"
date: "March 27, 2015"
output: html_document
---
```{r pulling data from the database, echo=FALSE}
url.cohort9 <- 'http://bridgeslab.uthsc.edu/mousedb/api/v1/data/?format=json&username=davebridges&api_key=fce3fde2a9a2e5dc9e04c20aad90120a621c50b3&limit=1000&offset=0&animal__cohort=15'

library(rjson)
library(RCurl)
json.cohort9 <- fromJSON(getURL(url.cohort9))

library(plyr)
cohort9.data <- rbind(ldply(lapply(json.cohort9[[2]],function(x) do.call(c,unlist(x,r=F))),as.data.frame))

date_after_fasting <- "2014-12-02"
date_before_fasting <- "2014-12-01"
date_12weeks_MRI <- "2015-02-24"

date_of_interest <- c("2014-12-01", "2014-12-02", "2015-02-24")

sub_cohort9.data <- cohort9.data[cohort9.data$experiment.date %in% date_of_interest,]
#Rename the fasting stage based on the date
sub_cohort9.data$Fasting_stat <- ifelse(sub_cohort9.data$experiment.date=="2014-12-01", "Pre_fasting",ifelse(sub_cohort9.data$experiment.date=="2014-12-02","After_fasting","After_HFD"))

#import body composition data
library(reshape2)
cohort9_weight <-dcast(sub_cohort9.data, animal.MouseID+Fasting_stat~assay.assay, value.var='values')

cohort9_weight$Lean <- as.numeric(cohort9_weight$'Lean Mass')/1000
cohort9_weight$Fat <- as.numeric(cohort9_weight$'Total Fat Mass')/1000
cohort9_weight$Weight <- as.numeric(cohort9_weight$'Body Weight')/1000
#calculate percent body fat
cohort9_weight$Percent.Fat <- cohort9_weight$Fat/cohort9_weight$Weight*100
#make animal id a factor
cohort9_weight$Subject <- as.factor(cohort9_weight$animal.MouseID)
cohort9_weight$Fasting_stat <- as.factor(cohort9_weight$Fasting_stat)
#set Pre_fasting as the reference level
cohort9_weight$Fasting_stat <- relevel(as.factor(cohort9_weight$Fasting_stat), ref='Pre_fasting')

#import CLAMS data
filename <- '../data/raw/Oxymax-2014-11-26.csv'
clams_data <- read.csv(filename)
#remove commented data
clams_data <- clams_data[clams_data$Event.Log=="",]
#data$Subject <- as.factor(data$Subject)
#mark which ones are actually in this experiment
start_fasting_interval <- 229
stop_fasting_interval <- 261
interval_time <- 32
#calculated elapsed time in hours
clams_data$Intervals.Elapsed <- clams_data$Interval - min(clams_data$Interval)
clams_data$Time <- clams_data$Intervals.Elapsed * interval_time/60
subjects <- c(seq(2098,2119,1),2128)
cohort9_clams <- clams_data[clams_data$Subject %in% subjects,]
cohort9_clams$Subject <- as.factor(cohort9_clams$Subject)
#determine dark/light cycles
#calculate when the first dark cycle starts
first.dark.cycle <- min(clams_data[clams_data$Light.Dark=='Dark',]$Time)
dark.cycles <- data.frame(
  Day1 = c(Start=first.dark.cycle,End=first.dark.cycle+12),
  Day2 = c(Start=first.dark.cycle+24,End=first.dark.cycle+36),
  Day3 = c(Start=first.dark.cycle+48,End=first.dark.cycle+60),
  Day4 = c(Start=first.dark.cycle+72,End=first.dark.cycle+84),
  Day5 = c(Start=first.dark.cycle+96,End=first.dark.cycle+108),
  Day6 = c(Start=first.dark.cycle+120,End=first.dark.cycle+132),
  Day7 = c(Start=first.dark.cycle+144,End=first.dark.cycle+156)
)
write.csv(cohort9_clams, file="../data/processed/cohort9_Oxymax.csv")
```

# Body Weight Analysis
```{r body-weight, echo=FALSE}
se <- function(x) sd(x)/sqrt(length(x))
library(ggplot2)
library(dplyr)
body_weight_summary <-
  cohort9_weight %>%
  group_by(Fasting_stat) %>%
  summarise(
    Weight = mean(Weight),
    Fat = mean(Fat),
    Lean = mean(Lean),
    Percent.Fat = mean(Percent.Fat))

body_weight_err <-
  cohort9_weight %>%
  group_by(Fasting_stat) %>%
  summarise(
    Weight = se(Weight),
    Fat = se(Fat),
    Lean = se(Lean),
    Percent.Fat = se(Percent.Fat))

body_weight_shapiro <-
  cohort9_weight %>%
  group_by(Fasting_stat) %>%
  summarise(
    Weight = shapiro.test(Weight)$p.value,
    Fat = shapiro.test(Fat)$p.value,
    Lean = shapiro.test(Lean)$p.value,
    Percent.Fat = shapiro.test(Percent.Fat)$p.value)

body_weight_delta <-
  cohort9_weight %>%
  group_by(animal.MouseID) %>%
  mutate(
    Delta_weight=c(0,diff(Weight)))

delta_weight<-body_weight_delta[body_weight_delta$Fasting_stat=="Pre_fasting",c(1,8,9,11)]

library(car)
body.weight.bartlett <- data.frame()
body.weight.bartlett['Weight','pval'] <- bartlett.test(Weight~Fasting_stat, data=cohort9_weight)$p.value
body.weight.bartlett['Fat','pval'] <- bartlett.test(Fat~Fasting_stat, data=cohort9_weight)$p.value
body.weight.bartlett['Lean','pval'] <- bartlett.test(Lean~Fasting_stat, data=cohort9_weight)$p.value
body.weight.bartlett['Percent.Fat','pval'] <- bartlett.test(Percent.Fat~Fasting_stat, data=cohort9_weight)$p.value

superpose.eb <- function (x, y, ebl, ebu = ebl, length = 0.08, ...)
  arrows(x, y + ebu, x, y - ebl, angle = 90, code = 3,
  length = length, ...)

par(mfrow=c(2,2))
ymax <- max(body_weight_summary$Weight + body_weight_err$Weight)
plot <- barplot(as.numeric(body_weight_summary$Weight),
                beside=T, las=1, main="Body Weight", ylim=c(0,ymax), col=c('blue','green','red'))
superpose.eb(plot,
             as.numeric(body_weight_summary$Weight),
             as.numeric(body_weight_err$Weight))

ymax <- max(body_weight_summary$Fat + body_weight_err$Fat)
plot <- barplot(as.numeric(body_weight_summary$Fat),
                beside=T, las=1, main="Total Fat Mass", ylim=c(0,ymax), col=c('blue','green','red'))

superpose.eb(plot,
             as.numeric(body_weight_summary$Fat),
             as.numeric(body_weight_err$Fat))

ymax <- max(body_weight_summary$Lean + body_weight_err$Lean)
plot <- barplot(as.numeric(body_weight_summary$Lean),
                beside=T, las=1, main="Lean Mass", ylim=c(0,ymax), col=c('blue','green','red'), names.arg=c("Prefasting","AfterFasting","AfterHFD"))
superpose.eb(plot,
             as.numeric(body_weight_summary$Lean),
             as.numeric(body_weight_err$Lean))

ymax <- max(body_weight_summary$Percent.Fat + body_weight_err$Percent.Fat)
plot <- barplot(as.numeric(body_weight_summary$Percent.Fat),
                beside=T, las=1, main="Percent Fat Mass", ylim=c(0,ymax), col=c('blue','green','red'),names.arg=c("Prefasting","AfterFasting","AfterHFD"))
superpose.eb(plot,
             as.numeric(body_weight_summary$Percent.Fat),
             as.numeric(body_weight_err$Percent.Fat))

ggplot(cohort9_weight, aes(x=Fasting_stat, y=Weight, group=Subject, colour=Subject)) + geom_point()+geom_line()+
  xlab("Fasting status")+
  ylab("Weight (g)")
```
```