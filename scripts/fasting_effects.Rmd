Effects of Fasting Induced Weight Loss
==========================================

Data
-----

```{r data-input, echo=FALSE, message=FALSE, warning=FALSE}
#set palette
library(RColorBrewer)
palette(brewer.pal(3, "Set2")[c(3,2)])

#a indicates the 10 weeks of age (pre-diet for cohort 5)
#before.fasting.a5 <- "http://bridgeslab.uthsc.edu/mousedb/experiment/84/csv"
#after.fasting.a5 <- "http://bridgeslab.uthsc.edu/mousedb/experiment/83/csv"
#before.fasting.data.a5 <- read.csv(before.fasting.a5)
#after.fasting.data.a5 <- read.csv(after.fasting.a5)
#before.fasting.a6 <- "http://bridgeslab.uthsc.edu/mousedb/experiment/100/csv"
#after.fasting.a6 <- "http://bridgeslab.uthsc.edu/mousedb/experiment/101/csv"
#before.fasting.data.a6 <- read.csv(before.fasting.a6)
#after.fasting.data.a6 <- read.csv(after.fasting.a6)

#b indicates the 22 weeks of age (10 weeks + 12 weeks high fat diet for cohorts 3,4,5 and 6)
#before.fasting.b3 <- "http://bridgeslab.uthsc.edu/mousedb/experiment/61/csv"
#after.fasting.b3 <- "http://bridgeslab.uthsc.edu/mousedb/experiment/62/csv"
#before.fasting.b4 <- "http://bridgeslab.uthsc.edu/mousedb/experiment/69/csv"
#after.fasting.b4 <- "http://bridgeslab.uthsc.edu/mousedb/experiment/70/csv"
#before.fasting.b5 <- "http://bridgeslab.uthsc.edu/mousedb/experiment/95/csv"
#after.fasting.b5 <- "http://bridgeslab.uthsc.edu/mousedb/experiment/96/csv"
#before.fasting.b6 <- "http://bridgeslab.uthsc.edu/mousedb/experiment/126/csv"
#after.fasting.b6 <- "http://bridgeslab.uthsc.edu/mousedb/experiment/127/csv"
#before.fasting.data.b3 <- read.csv(before.fasting.b3)
#after.fasting.data.b3 <- read.csv(after.fasting.b3)
#before.fasting.data.b4 <- read.csv(before.fasting.b4)
#after.fasting.data.b4 <- read.csv(after.fasting.b4)
#before.fasting.data.b5 <- read.csv(before.fasting.b5)
#after.fasting.data.b5 <- read.csv(after.fasting.b5)
#before.fasting.data.b6 <- read.csv(before.fasting.b6)
#after.fasting.data.b6 <- read.csv(after.fasting.b6)

#rapa indicates the rapamycin cohort
#before.fasting.rapa1 <- "http://bridgeslab.uthsc.edu/mousedb/experiment/56/csv"
#after.fasting.rapa1 <- "http://bridgeslab.uthsc.edu/mousedb/experiment/57/csv"
#before.fasting.data.rapa1 <- read.csv(before.fasting.rapa1)
#after.fasting.data.rapa1 <- read.csv(after.fasting.rapa1)

#combind all the data into one data frame, only looking at body weight
#weights <- rbind(subset(before.fasting.data.a5, Assay == "Body Weight"),
#                 subset(after.fasting.data.a5, Assay == "Body Weight"),
#                 subset(before.fasting.data.a6, Assay == "Body Weight"),
#                 subset(after.fasting.data.a6, Assay == "Body Weight"),
#                 subset(before.fasting.data.b3, Assay == "Body Weight"),
#                 subset(after.fasting.data.b3, Assay == "Body Weight"),
#                 subset(before.fasting.data.b4, Assay == "Body Weight"),
#                 subset(after.fasting.data.b4, Assay == "Body Weight"),
#                 subset(before.fasting.data.b5, Assay == "Body Weight"),
#                 subset(after.fasting.data.b5, Assay == "Body Weight"), 
#                 subset(before.fasting.data.b6, Assay == "Body Weight"),
#                 subset(after.fasting.data.b6, Assay == "Body Weight"),                  
#                 subset(before.fasting.data.rapa1, Assay == "Body Weight"),
#                 subset(after.fasting.data.rapa1, Assay == "Body Weight")                )                 
#weights <- droplevels(weights)
#rename the treatments into useful names
#levels(weights$Treatment) <- c("Control Diet",
#                               "High Fat Diet",
#                               NA,
#                               "Normal Chow Diet",
#                               "Rapamycin + High Fat Diet",
#                               "Rapamycin + Normal Chow Diet",
#                               "Sham + High Fat Diet",
#                               "Sham + Normal Chow Diet")
#weights$HFD <- grepl("High Fat Diet", weights$Treatment) 
#weights$Rapamycin <- grepl("Rapamycin", weights$Treatment)
#weights$Weight <- weights$Values/1000

input_file = '../data/raw/body_weights_file.csv'
#write.csv(weights, input_file)
weights <- read.csv(input_file,row.names='X')

require(reshape)
weight.data <- cast(weights, Animal~Feeding, mean, value="Weight")
weight.data <- merge(weight.data, weights[!duplicated(weights$Animal),c("Animal", "Cage", "Treatment", "HFD" ,"Age", "Rapamycin")])
weight.data$Loss <- weight.data$fed - weight.data$fasted
weight.data$Loss.pct <- weight.data$Loss/weight.data$fed*100
```

This analysis uses the fed and fasted data from C57BL6/J mice at three time points.  There was a total of `r dim(weight.data[weight.data$HFD==FALSE&weight.data$Rapamycin==FALSE,])[1]` mice analysed from these cohorts.  The first is the pre-diet fasting data (experiments 83/84 and 100/101, from cohorts 5 and 6), the second is the post-12 weeks high fat diet (experiments 61/62 and 69/70 from cohorts 3,4 and 5) and the third is at the end of the rapamycin treatment experiment (experiments 56 and 57).  The input file for this is `r input_file` and this script was most recently run on `r date()`

Analysis
----------

```{r linear-modeling-loss, echo=FALSE}
loss.lm <- lm(Loss~Age, data=weight.data[weight.data$HFD==FALSE&weight.data$Rapamycin==FALSE,])
loss.pct.lm <- lm(Loss.pct~Age, data=weight.data[weight.data$HFD==FALSE&weight.data$Rapamycin==FALSE,])
#removes outliers
loss.pct.lm.rm.outliers <- lm(Loss.pct~Age, data=weight.data[weight.data$HFD==FALSE&weight.data$Rapamycin==FALSE&weight.data$Loss.pct>2&weight.data$Loss.pct<15,])
library(MASS)
loss.rlm <- rlm(Loss~Age, data=weight.data[weight.data$HFD==FALSE&weight.data$Rapamycin==FALSE,])
loss.pct.rlm <- rlm(Loss.pct~Age, data=weight.data[weight.data$HFD==FALSE&weight.data$Rapamycin==FALSE,])
```

### Weight Loss on Normal Chow Diet


We tested whether there was a trend towards weight loss or percentage weight loss with age in the Normal Chow Diet Fed Animals.  First we tested whether there is a correlation between Age and Weight loss (r=**`r round(with(weight.data[weight.data$HFD==FALSE&weight.data$Rapamycin==FALSE,], cor.test(Loss,Age)$estimate),3)`**, R2=**`r round(with(weight.data[weight.data$HFD==FALSE&weight.data$Rapamycin==FALSE,], cor.test(Loss,Age)$estimate^2),4)`** p=**`r round(with(weight.data[weight.data$HFD==FALSE&weight.data$Rapamycin==FALSE,], cor.test(Loss,Age)$p.value),3)`**) or percentage weight loss (r=**`r round(with(weight.data[weight.data$HFD==FALSE&weight.data$Rapamycin==FALSE,], cor.test(Loss.pct,Age)$estimate),3)`**, R2=**`r round(with(weight.data[weight.data$HFD==FALSE&weight.data$Rapamycin==FALSE,], cor.test(Loss.pct,Age)$estimate^2),4)`** p=**`r round(with(weight.data[weight.data$HFD==FALSE&weight.data$Rapamycin==FALSE,], cor.test(Loss.pct,Age)$p.value),3)`**).  

We next generated simple linar models to test the size of this effect.  The results of these linear models are shown in the tables below.  The adjusted r-squared for these models are **`r round(summary(loss.lm)$adj.r.squared,5)`** for weight loss and **`r round(summary(loss.pct.lm)$adj.r.squared,5)`** for percentage weight loss.  These data are presented graphically below.

```{r lm-tables,echo=FALSE,results='asis', message=FALSE}
require(xtable)
print(xtable(loss.lm, caption = "Linear Models for Fasting Induced Weight Loss for Mice on a Normal Chow Diet", label = "tab:lm-loss"), type="html")
print(xtable(loss.pct.lm, caption = "Linear Models for Fasting Induced Percentage Weight Loss for Mice on a Normal Chow Diet", label = "tab:lm-loss-pct"), type="html")
```

```{r ncd-fasting-response, echo=FALSE, dev=c('png','pdf')}
with(weight.data[weight.data$HFD==FALSE&weight.data$Rapamycin==FALSE,], plot(Age, Loss, 
                       pch=19,
                       cex=0.5,
                       ylab="Fasting Induced Weight Loss (g)",
                       xlab="Age (days)",
                       ylim=c(0,max(Loss, na.rm=T)),                        
                       xlim=c(0,max(Age))))
abline(loss.lm)
```

```{r ncd-fasting-response-pct, echo=FALSE, dev=c('png','pdf')}
with(weight.data[weight.data$HFD==FALSE&weight.data$Rapamycin==FALSE,], plot(Age, Loss.pct, 
                       pch=19,
                       cex=0.5,
                       ylab="Fasting Induced Weight Loss (% of Fed)",
                       xlab="Age (days)",
                       ylim=c(0,max(Loss.pct, na.rm=T)),                        
                       xlim=c(0,max(Age))))
abline(loss.pct.lm)
```

### Effect of outliers on interpretation of longitudinal fasting weight loss

There were two outliers noted by one of the reviewers that may affect our interpretation.  These outliers were `r as.character(weight.data[weight.data$Loss.pct < 2,]$Animal)` which lost less than 2% of their body weight, and `r as.character(weight.data[weight.data$Loss.pct > 15,]$Animal)`. which lost more than 15% of their body weight at some stage.  If we remove these outliers the adjusted R<sup>2</sup> goes from `r summary(loss.pct.lm)$r.squared` to `r summary(loss.pct.lm.rm.outliers)$r.squared`.

We also calculated correlation coeffecients for both the entire dataset.  Because the residuals for the percent loss linear model were normally distributed (Shapiro-Wilk test p=`r shapiro.test(residuals(loss.pct.lm))$p.value` for percent weight loss and `r shapiro.test(residuals(loss.lm))$p.value` for absolute weight loss).  Therefore correlations coefficients will be from Spearman's Rank Order test

For percent weight loss upon fasting the Spearman's rank ordered test showed no significant correlation.
(r=`r with(data=weight.data[weight.data$HFD==FALSE&weight.data$Rapamycin==FALSE,], cor.test(Loss.pct,Age))$estimate` r<sup>2</sup>= `r with(data=weight.data[weight.data$HFD==FALSE&weight.data$Rapamycin==FALSE,], cor.test(Loss.pct,Age,method="spearman"))$estimate^2` and p=`r with(data=weight.data[weight.data$HFD==FALSE&weight.data$Rapamycin==FALSE,], cor.test(Loss.pct,Age,method="spearman"))$p.value`) and with outliers removed (r=`r with(data=weight.data[weight.data$HFD==FALSE&weight.data$Rapamycin==FALSE&weight.data$Loss.pct>2&weight.data$Loss.pct<15,], cor.test(Loss.pct,Age,method="spearman"))$estimate` r<sup>2</sup>= `r with(data=weight.data[weight.data$HFD==FALSE&weight.data$Rapamycin==FALSE&weight.data$Loss.pct>2&weight.data$Loss.pct<15,], cor.test(Loss.pct,Age,method="spearman"))$estimate^2` and p=`r with(data=weight.data[weight.data$HFD==FALSE&weight.data$Rapamycin==FALSE&weight.data$Loss.pct>2&weight.data$Loss.pct<15,], cor.test(Loss.pct,Age,method="spearman"))$p.value`).  For total weight loss there was also no correlation (r=`r with(data=weight.data[weight.data$HFD==FALSE&weight.data$Rapamycin==FALSE,], cor.test(Loss,Age))$estimate` r<sup>2</sup>= `r with(data=weight.data[weight.data$HFD==FALSE&weight.data$Rapamycin==FALSE,], cor.test(Loss,Age,method="spearman"))$estimate^2` and p=`r with(data=weight.data[weight.data$HFD==FALSE&weight.data$Rapamycin==FALSE,], cor.test(Loss,Age,method="spearman"))$p.value`) and with outliers removed (r=`r with(data=weight.data[weight.data$HFD==FALSE&weight.data$Rapamycin==FALSE&weight.data$Loss.pct>2&weight.data$Loss.pct<15,], cor.test(Loss,Age,method="spearman"))$estimate` r<sup>2</sup>= `r with(data=weight.data[weight.data$HFD==FALSE&weight.data$Rapamycin==FALSE&weight.data$Loss.pct>2&weight.data$Loss.pct<15,], cor.test(Loss,Age,method="spearman"))$estimate^2` and p=`r with(data=weight.data[weight.data$HFD==FALSE&weight.data$Rapamycin==FALSE&weight.data$Loss.pct>2&weight.data$Loss.pct<15,], cor.test(Loss,Age,method="spearman"))$p.value`).

Longitudinal Analysis of Fasting Induced Weight Loss
-----------------------------------------------------

```{r linear-modeling-before, echo=FALSE}
#This rebuilds the data frames of just cohorts 5 and 6
#cohort5 <- rbind(
#      subset(before.fasting.data.a5, Assay == "Body Weight"),
#      subset(after.fasting.data.a5, Assay == "Body Weight"),
#      subset(before.fasting.data.b5, Assay == "Body Weight"),
#      subset(after.fasting.data.b5, Assay == "Body Weight"))
#write.csv(cohort5, '../data/raw/body_weights_file_cohort_5.csv')
#cohort5 <- read.csv('../data/raw/body_weights_file_cohort_5.csv', row.names='X')
#cohort6 <- rbind(
#      subset(before.fasting.data.a6, Assay == "Body Weight"),
#      subset(after.fasting.data.a6, Assay == "Body Weight"),
#      subset(before.fasting.data.b6, Assay == "Body Weight"),
#      subset(after.fasting.data.b6, Assay == "Body Weight"))
#write.csv(cohort5, '../data/raw/body_weights_file_cohort_6.csv')
#cohort6 <- read.csv('../data/raw/body_weights_file_cohort_6.csv', row.names='X')

#rename the treatments into useful names
#levels(cohort5$Treatment) <- c(NA, "Control Diet",
#                               "High Fat Diet")
#levels(cohort6$Treatment) <- c(NA, "Control Diet",
#                               "High Fat Diet")
#cohort5$Weight <- cohort5$Values/1000
#cohort6$Weight <- cohort6$Values/1000

#cohort5.data <- cast(subset(cohort5, Animal!="C57BL/6J-EarTag #36"), Treatment+Animal~Age, value="Weight", mean)
#colnames(cohort5.data) <- c("Treatment","Animal", "Early.Fed", "Early.Fasted", "Late.Fed", "Late.Fasted")
#cohort5.data$Cohort <- rep("Cohort 5", dim(cohort5.data)[1])
#cohort6.data <- cast(subset(cohort6, Animal!="C57BL/6J-EarTag #36"), Treatment+Animal~Age, value="Weight", mean)
#colnames(cohort6.data) <- c("Treatment","Animal", "Early.Fed", "Early.Fasted", "Late.Fed", "Late.Fasted")
#cohort6.data$Cohort <- rep("Cohort 6", dim(cohort6.data)[1])

#combine the two cohorts
#cohort5.6.data <- rbind(cohort5.data,cohort6.data)
fasting_data_file <- "../data/processed/fasting_weights_file.csv"
cohort5.6.data <- read.csv(fasting_data_file, row.names="X")
#calculated fasting induced weight loss
cohort5.6.data$Early <- (cohort5.6.data$Early.Fed-cohort5.6.data$Early.Fasted)
cohort5.6.data$Late <- (cohort5.6.data$Late.Fed-cohort5.6.data$Late.Fasted)
cohort5.6.data$Early.pct <- cohort5.6.data$Early/cohort5.6.data$Early.Fed*100
cohort5.6.data$Late.pct <- cohort5.6.data$Late/cohort5.6.data$Late.Fed*100

#calculated weight gain during intervention
cohort5.6.data$Gain <- cohort5.6.data$Late.Fed - cohort5.6.data$Early.Fed
cohort5.6.data$Gain.pct <- cohort5.6.data$Gain/cohort5.6.data$Early.Fed*100

#calculated correlation coefficients
fasting.cor.abs <- with(cohort5.6.data, cor.test(Late,Early, method='spearman'))
fasting.cor.pct <- with(cohort5.6.data, cor.test(Late.pct,Early.pct,  method='spearman'))

#calculated correlation coefficients separated by diet
fasting.cor.abs.hfd <- with(cohort5.6.data[cohort5.6.data$Treatment=="High Fat Diet",], cor.test(Late,Early, method='spearman'))
fasting.cor.abs.cd <- with(cohort5.6.data[cohort5.6.data$Treatment=="Control Diet",], cor.test(Late,Early, method='spearman'))
fasting.cor.pct.hfd <- with(cohort5.6.data[cohort5.6.data$Treatment=="High Fat Diet",], cor.test(Late.pct,Early.pct, method='spearman'))
fasting.cor.pct.cd <- with(cohort5.6.data[cohort5.6.data$Treatment=="Control Diet",], cor.test(Late.pct,Early.pct, method='spearman'))


fasting.lm.abs <- lm(Late~Treatment+Early, data=cohort5.6.data)
fasting.lm.pct <- lm(Late.pct~Treatment+Early.pct, data=cohort5.6.data)
fasting.lm.pct.int <- lm(Late.pct~Treatment*Early.pct, data=cohort5.6.data)
```

Both pre- and post-diet fasting responses were not normally distributed.  For pre-diet the Shapiro-Wilk test had a p-value of `r shapiro.test(cohort5.6.data$Early)$p.value` for absolute weight loss and `r shapiro.test(cohort5.6.data$Early.pct)$p.value` for relative weight loss.  For post-diet fasting responses, the results were `r shapiro.test(cohort5.6.data$Late)$p.value` for absolute weight loss and `r shapiro.test(cohort5.6.data$Late.pct)$p.value` for percent weight loss.  Therefore to test correlations between these factors we used Spearman's Rank Order Test.

We next tested whether weight loss pre-diet has any effect on weight loss later on.  This used the data file `r fasting_data_file`.  In other words, is weight loss consistent within animals. There was a correlation between percentage weight loss pre-diet and weight loss post-diet (r=`r round(fasting.cor.pct$estimate,3)`, R2=`r round(fasting.cor.pct$estimate^2,3)`, p=`r round(fasting.cor.pct$p.value,20)`) and absolute weight loss (r=`r round(fasting.cor.abs$estimate,3)`, R2=`r round(fasting.cor.abs$estimate^2,3)`, p=`r round(fasting.cor.abs$p.value,3)`) when the diets are combined.  To account for the potential confounding effect of dietary treatment, we tested each diet separately.  


#### High Fat Diet Within-Mouse Correlations

For High Fat Diet pre-diet values, the Shapiro-Wilk test had a p-value of `r shapiro.test(cohort5.6.data[cohort5.6.data$Treatment=="High Fat Diet",]$Early)$p.value` for absolute weight loss and `r shapiro.test(cohort5.6.data[cohort5.6.data$Treatment=="High Fat Diet",]$Early.pct)$p.value` for relative weight loss. For post-diet the Shapiro-Wilk test had a p-value of `r shapiro.test(cohort5.6.data[cohort5.6.data$Treatment=="High Fat Diet",]$Late)$p.value` for absolute weight loss and `r shapiro.test(cohort5.6.data[cohort5.6.data$Treatment=="High Fat Diet",]$Late.pct)$p.value` for relative weight loss.  Based on this we did a Spearman Rank-Order test and found that there was a modest correlation between percentage weight loss pre-diet and weight loss post-diet (r=`r round(fasting.cor.pct.hfd$estimate,3)`, R2=`r round(fasting.cor.pct.hfd$estimate^2,3)`, p=`r round(fasting.cor.pct.hfd$p.value,20)`) and absolute weight loss (r=`r round(fasting.cor.abs.hfd$estimate,3)`, R2=`r round(fasting.cor.abs.hfd$estimate^2,3)`, p=`r round(fasting.cor.abs.hfd$p.value,3)`).

#### Control Diet Within-Mouse Correlations

For Control Diet pre-diet values, the Shapiro-Wilk test had a p-value of `r shapiro.test(cohort5.6.data[cohort5.6.data$Treatment=="Control Diet",]$Early)$p.value` for absolute weight loss and `r shapiro.test(cohort5.6.data[cohort5.6.data$Treatment=="Control Diet",]$Early.pct)$p.value` for relative weight loss. For post-diet the Shapiro-Wilk test had a p-value of `r shapiro.test(cohort5.6.data[cohort5.6.data$Treatment=="Control Diet",]$Late)$p.value` for absolute weight loss and `r shapiro.test(cohort5.6.data[cohort5.6.data$Treatment=="Control Diet",]$Late.pct)$p.value` for relative weight loss.  Based on this we did a Spearman Rank-Order test and found that there was a modest correlation between percentage weight loss pre-diet and weight loss post-diet (r=`r round(fasting.cor.pct.cd$estimate,3)`, R2=`r round(fasting.cor.pct.cd$estimate^2,3)`, p=`r round(fasting.cor.pct.cd$p.value,20)`) and absolute weight loss (r=`r round(fasting.cor.abs.cd$estimate,3)`, R2=`r round(fasting.cor.abs.cd$estimate^2,3)`, p=`r round(fasting.cor.abs.cd$p.value,3)`).

```{r fasting-loss-plot,fig=TRUE,echo=FALSE, dev=c('png','pdf')}
with(cohort5.6.data, plot(Early,Late, col=Treatment, pch=19,las=1,
                        main="Fasting Induced Weight Loss",
                        xlab="Pre-Diet Weight Loss (g)",
                        ylab="Post-Diet Weight Loss (g)",
                        xlim=c(0,max(Early, na.rm=T)),
                        ylim=c(0,max(Late, na.rm=T))
                      ))
with(subset(cohort5.6.data, Treatment=="Control Diet"), abline(lm(Late~Early), col=palette()[1]))
with(subset(cohort5.6.data, Treatment=="High Fat Diet"), abline(lm(Late~Early), col=palette()[2]))
legend("topleft", levels(cohort5.6.data$Treatment), col=palette()[1:2], lty=1, pch=19, bty="n")
```

```{r fasting-loss-plot-pct,fig=TRUE,echo=FALSE, dev=c('png','pdf')}
with(cohort5.6.data, plot(Early.pct,Late.pct, col=Treatment, pch=19,las=1,
                        main="Fasting Induced Percent Weight Loss",
                        xlab="Pre-Diet Weight Loss (% of Fed)",
                        ylab="Post-Diet Weight Loss (% of Fed)",
                        xlim=c(0,max(Early.pct, na.rm=T)),
                        ylim=c(0,max(Late.pct, na.rm=T))
                      ))
with(subset(cohort5.6.data, Treatment=="Control Diet"), abline(lm(Late.pct~Early.pct), col=palette()[1]))
with(subset(cohort5.6.data, Treatment=="High Fat Diet"), abline(lm(Late.pct~Early.pct), col=palette()[2]))
legend("topleft", levels(cohort5.6.data$Treatment), col=palette()[1:2], lty=1, pch=19, bty="n")
```

### Effects of cohort on the lack of correlation between pre-diet and post-diet fasting resposnes.

Since this analysis used both cohorts, and as described above did not observe a trend when combined, we separated these analyses by cohort.

The correlations betwen pre-diet fasting percent response and post-diet percent fasting response by cohort are:

```{r within-mouse-fasting-responses, echo=FALSE, message=FALSE, results='asis'}
within.mouse.cohort <- data.frame(row.names=c("Cohort 5 Absolute", "Cohort 5 Relative", "Cohort 6 Absolute", "Cohort 6 Relative"))

within.mouse.cohort['Cohort 5 Relative','pval-cd'] <- with(subset(cohort5.6.data, Treatment=="Control Diet"&Cohort=="Cohort 5"), cor.test(Early.pct,Late.pct)$p.value)
within.mouse.cohort['Cohort 5 Relative','Rho-cd'] <- with(subset(cohort5.6.data, Treatment=="Control Diet"&Cohort=="Cohort 5"), cor.test(Early.pct,Late.pct)$estimate)
within.mouse.cohort['Cohort 5 Relative','Rho^2-cd'] <- with(subset(cohort5.6.data, Treatment=="Control Diet"&Cohort=="Cohort 5"), cor.test(Early.pct,Late.pct)$estimate^2)

within.mouse.cohort['Cohort 5 Relative','pval-hfd'] <- with(subset(cohort5.6.data, Treatment=="High Fat Diet"&Cohort=="Cohort 5"), cor.test(Early.pct,Late.pct)$p.value)
within.mouse.cohort['Cohort 5 Relative','Rho-hfd'] <- with(subset(cohort5.6.data, Treatment=="High Fat Diet"&Cohort=="Cohort 5"), cor.test(Early.pct,Late.pct)$estimate)
within.mouse.cohort['Cohort 5 Relative','Rho^2-hfd'] <- with(subset(cohort5.6.data, Treatment=="High Fat Diet"&Cohort=="Cohort 5"), cor.test(Early.pct,Late.pct)$estimate^2)

within.mouse.cohort['Cohort 6 Relative','pval-cd'] <- with(subset(cohort5.6.data, Treatment=="Control Diet"&Cohort=="Cohort 6"), cor.test(Early.pct,Late.pct)$p.value)
within.mouse.cohort['Cohort 6 Relative','Rho-cd'] <- with(subset(cohort5.6.data, Treatment=="Control Diet"&Cohort=="Cohort 6"), cor.test(Early.pct,Late.pct)$estimate)
within.mouse.cohort['Cohort 6 Relative','Rho^2-cd'] <- with(subset(cohort5.6.data, Treatment=="Control Diet"&Cohort=="Cohort 6"), cor.test(Early.pct,Late.pct)$estimate^2)

within.mouse.cohort['Cohort 6 Relative','pval-hfd'] <- with(subset(cohort5.6.data, Treatment=="High Fat Diet"&Cohort=="Cohort 6"), cor.test(Early.pct,Late.pct)$p.value)
within.mouse.cohort['Cohort 6 Relative','Rho-hfd'] <- with(subset(cohort5.6.data, Treatment=="High Fat Diet"&Cohort=="Cohort 6"), cor.test(Early.pct,Late.pct)$estimate)
within.mouse.cohort['Cohort 6 Relative','Rho^2-hfd'] <- with(subset(cohort5.6.data, Treatment=="High Fat Diet"&Cohort=="Cohort 6"), cor.test(Early.pct,Late.pct)$estimate^2)

within.mouse.cohort['Cohort 5 Absolute','pval-cd'] <- with(subset(cohort5.6.data, Treatment=="Control Diet"&Cohort=="Cohort 5"), cor.test(Early,Late)$p.value)
within.mouse.cohort['Cohort 5 Absolute','Rho-cd'] <- with(subset(cohort5.6.data, Treatment=="Control Diet"&Cohort=="Cohort 5"), cor.test(Early,Late)$estimate)
within.mouse.cohort['Cohort 5 Absolute','Rho^2-cd'] <- with(subset(cohort5.6.data, Treatment=="Control Diet"&Cohort=="Cohort 5"), cor.test(Early,Late)$estimate^2)

within.mouse.cohort['Cohort 5 Absolute','pval-hfd'] <- with(subset(cohort5.6.data, Treatment=="High Fat Diet"&Cohort=="Cohort 5"), cor.test(Early,Late)$p.value)
within.mouse.cohort['Cohort 5 Absolute','Rho-hfd'] <- with(subset(cohort5.6.data, Treatment=="High Fat Diet"&Cohort=="Cohort 5"), cor.test(Early,Late)$estimate)
within.mouse.cohort['Cohort 5 Absolute','Rho^2-hfd'] <- with(subset(cohort5.6.data, Treatment=="High Fat Diet"&Cohort=="Cohort 5"), cor.test(Early,Late)$estimate^2)

within.mouse.cohort['Cohort 6 Absolute','pval-cd'] <- with(subset(cohort5.6.data, Treatment=="Control Diet"&Cohort=="Cohort 6"), cor.test(Early,Late)$p.value)
within.mouse.cohort['Cohort 6 Absolute','Rho-cd'] <- with(subset(cohort5.6.data, Treatment=="Control Diet"&Cohort=="Cohort 6"), cor.test(Early,Late)$estimate)
within.mouse.cohort['Cohort 6 Absolute','Rho^2-cd'] <- with(subset(cohort5.6.data, Treatment=="Control Diet"&Cohort=="Cohort 6"), cor.test(Early,Late)$estimate^2)

within.mouse.cohort['Cohort 6 Absolute','pval-hfd'] <- with(subset(cohort5.6.data, Treatment=="High Fat Diet"&Cohort=="Cohort 6"), cor.test(Early,Late)$p.value)
within.mouse.cohort['Cohort 6 Absolute','Rho-hfd'] <- with(subset(cohort5.6.data, Treatment=="High Fat Diet"&Cohort=="Cohort 6"), cor.test(Early,Late)$estimate)
within.mouse.cohort['Cohort 6 Absolute','Rho^2-hfd'] <- with(subset(cohort5.6.data, Treatment=="High Fat Diet"&Cohort=="Cohort 6"), cor.test(Early,Late)$estimate^2)
```

```{r cohort-within-mouse-table, echo=FALSE,results='html'}
within.mouse.cohort
```

```{r fasting-loss-plot-cohort,fig=TRUE,echo=FALSE, dev=c('png','pdf')}
par(mfrow=c(1,2))
for (cohort in levels(cohort5.6.data$Cohort)) {
with(subset(cohort5.6.data, Cohort==cohort), plot(Early,Late, col=Treatment, pch=19,las=1,
                        main=cohort,
                        xlab="Pre-Diet Weight Loss (g)",
                        ylab="Post-Diet Weight Loss (g)",
                        xlim=c(0,5),
                        ylim=c(0,5)
                      ))
with(subset(cohort5.6.data, Cohort==cohort&Treatment=="Control Diet"), abline(lm(Late~Early), col=palette()[1]))
with(subset(cohort5.6.data, Cohort==cohort&Treatment=="High Fat Diet"), abline(lm(Late~Early), col=palette()[2]))
legend("topleft", levels(cohort5.6.data$Treatment), col=palette()[1:2], lty=1, pch=19, bty="n")
}
```

```{r fasting-loss-plot-pct-cohort,fig=TRUE,echo=FALSE, dev=c('png','pdf')}
par(mfrow=c(1,2))
for (cohort in levels(cohort5.6.data$Cohort)) {
with(cohort5.6.data, plot(Early.pct,Late.pct, col=Treatment, pch=19,las=1,
                        main=cohort,
                        xlab="Pre-Diet Weight Loss (% of Fed)",
                        ylab="Post-Diet Weight Loss (% of Fed)",
                        xlim=c(0,max(Early.pct, na.rm=T)),
                        ylim=c(0,max(Late.pct, na.rm=T))
                      ))
with(subset(cohort5.6.data, Treatment=="Control Diet"), abline(lm(Late.pct~Early.pct), col=palette()[1]))
with(subset(cohort5.6.data, Treatment=="High Fat Diet"), abline(lm(Late.pct~Early.pct), col=palette()[2]))
legend("topleft", levels(cohort5.6.data$Treatment), col=palette()[1:2], lty=1, pch=19, bty="n")
}
```

Effects Relative to Body Weight
--------------------------------

```{r fasting-loss-fed,fig=TRUE,echo=FALSE, dev=c('png','pdf')}
with(cohort5.6.data, plot(Late.Fed,Late, col=Treatment, pch=19,
                        main="Fasting Induced Weight Loss",
                        xlab="Pre-Fast Weight (g)",
                        ylab="Weight Loss (g)",
                        xlim=c(0,max(Late.Fed, na.rm=T)),
                        ylim=c(0,max(Late, na.rm=T))
                      ))
with(subset(cohort5.6.data, Treatment=="Control Diet"), abline(lm(Late~Late.Fed), col=palette()[1]))
with(subset(cohort5.6.data, Treatment=="High Fat Diet"), abline(lm(Late~Late.Fed), col=palette()[2]))
legend("topleft", levels(cohort5.6.data$Treatment), col=palette()[1:2], lty=1, pch=19, bty="n")
```

```{r fasting-loss-fed-pct,fig=TRUE,echo=FALSE, dev=c('png','pdf')}
with(cohort5.6.data, plot(Late.Fed,Late.pct, col=Treatment, pch=19,
                        main="Fasting Induced Percent Weight Loss",
                        xlab="Pre-Fast Weight (g)",
                        ylab="Weight Loss (% of Fed)",
                        xlim=c(0,max(Late.Fed, na.rm=T)),
                        ylim=c(0,max(Late.pct, na.rm=T))
                      ))
with(subset(cohort5.6.data, Treatment=="Control Diet"), abline(lm(Late.pct~Late.Fed), col=palette()[1]))
with(subset(cohort5.6.data, Treatment=="High Fat Diet"), abline(lm(Late.pct~Late.Fed), col=palette()[2]))
legend("topleft", levels(cohort5.6.data$Treatment), col=palette()[1:2], lty=1, pch=19, bty="n")
``` 


Effects of Diet on the Fasting Response
-----------------------------------------

```{r fasting-weights-data, echo=FALSE}
fasting_weights_file <- '../data/raw/Raw Weights Data - Fasting.csv'
fasting.weights <- read.csv(fasting_weights_file)
weight.data <- cast(fasting.weights, Animal~Feeding, mean, value="Weight")
weight.data <- merge(weight.data, fasting.weights[!duplicated(fasting.weights$Animal),c("Animal", "Cage", "Treatment","Cohort")])
weight.data$Loss <- weight.data$fed - weight.data$fasted
weight.data$Gain <- weight.data$refed - weight.data$fasted
weight.data$Loss.pct <- weight.data$Loss/weight.data$fed*100
weight.data$Gain.pct <- weight.data$Gain/weight.data$fasted*100
weight.data$Treatment <- factor(weight.data$Treatment,levels(weight.data$Treatment)[c(3,2,1)])
```

We checked at the end point of the experiments what the effects of fasting were.  This tests whether the diet and/or weight affects the fasting response.  These data come from the file `r fasting_weights_file`.

```{r fasting-weights-stats, echo=FALSE, message=FALSE}
library(plyr)
summary.means <- ddply(weight.data, ~Treatment, summarize,
                       Fasted.Weight = mean(fasted, na.rm=T),
                       Fed.Weight = mean(fed, na.rm=T),
                       Refed.Weight = mean(refed, na.rm=T),                       
                       Loss = mean(Loss, na.rm=T), 
                       Loss.pct = mean(Loss.pct, na.rm=T),
                       Gain = mean(Gain, na.rm=T), 
                       Gain.pct = mean(Gain.pct, na.rm=T))

se <- function(x) sd(x, na.rm=T)/sqrt(length(x))
summary.se <- ddply(weight.data, ~Treatment, summarize,
                       Fasted.Weight = se(fasted),
                       Fed.Weight = se(fed),
                       Refed.Weight = se(refed),                    
                       Loss = se(Loss), 
                       Loss.pct = se(Loss.pct),
                       Gain = se(Gain), 
                       Gain.pct = se(Gain.pct))

fasted.anova <- aov(fasted~Treatment, data=weight.data)
fed.anova <- aov(fed~Treatment, data=weight.data)
refed.anova <- aov(refed~Treatment, data=weight.data)
loss.anova <- aov(Loss~Treatment, data=weight.data)
loss.pct.anova <- aov(Loss.pct~Treatment, data=weight.data)
loss.pct.kw <- kruskal.test(Loss.pct~Treatment, data=weight.data)
gain.anova <- aov(Gain~Treatment, data=weight.data)
gain.kw <- kruskal.test(Gain~Treatment, data=weight.data)
gain.pct.anova <-  aov(Gain.pct~Treatment, data=weight.data)
gain.pct.kw <- kruskal.test(Gain.pct~Treatment, data=weight.data)
```

### Absolute Weight Loss

We checked based on the ANOVA analysis whether the residuals were equally distributed.  For absolute weight loss, the p-value from the Shapiro-Wilk test was `r shapiro.test(residuals(loss.anova))$p.value` so therefore an ANOVA was appropriate.  The results of this ANOVA showed Treatment having an effect with a p-value of `r summary(loss.anova)[[1]]$"Pr(>F)"[1]`.  We therefore did a post-hoc Tukey's test on this:

```{r dunnet-loss-abs}
TukeyHSD(loss.anova)$Treatment
```

```{r fasting-diet-abs, dev=c('png','pdf'), echo=FALSE}
fasting_palette <- brewer.pal(3, "Set2")
superpose.eb <- function (x, y, ebl, ebu = ebl, length = 0.08, ...)
arrows(x, y + ebu, x, y - ebl, angle = 90, code = 3,
length = length, ...)

max <- max(summary.means$Loss + summary.se$Loss)
plot <- barplot(summary.means$Loss,
                ylab = "Fasting Induced Change in Body Weight (g)",
                beside=T,las=1,col=fasting_palette,
                names.arg = summary.means$Treatment,
                ylim = c(0,max))

superpose.eb(plot, 
             summary.means$Loss, 
             summary.se$Loss)
```

### Relative Weight Loss

We checked based on the ANOVA analysis whether the residuals were equally distributed.  For percentage weight loss, the p-value from the Shapiro-Wilk test was `r shapiro.test(residuals(loss.pct.anova))$p.value` so therefore an ANOVA was **not** appropriate.  The results of the Kruskal-Wallis are shown below, with the Treatment having an effect with a p-value of `r loss.pct.kw$p.value`.  We therefore did post-hoc Wilcoxon Rank Sum Tests:

```{r wilcoxon-loss-pct}
pairwise.wilcox.test(weight.data$Loss.pct, weight.data$Treatment, p.adjust.method="BH")
```

```{r fasting-diet-pct, dev=c('png','pdf'), echo=FALSE}
max <- max(summary.means$Loss.pct + summary.se$Loss.pct)
plot <- barplot(summary.means$Loss.pct,
                ylab = "Fasting Induced Change in Body Weight (% Change)",
                beside=T,las=1,col=fasting_palette,
                names.arg = summary.means$Treatment,
                ylim = c(0,max))

superpose.eb(plot, 
             summary.means$Loss.pct, 
             summary.se$Loss.pct)
```

#### Relative Weight Loss Accross Cohorts

To test whether the enhanced relative weight loss was not consistent accross cohorts we separated these analyses by cohort.

```{r relative-weight-loss-cohort, echo=FALSE}
summary.means.cohort <- ddply(weight.data, .(Treatment,Cohort), summarize,
                       Fasted.Weight = mean(fasted, na.rm=T),
                       Fed.Weight = mean(fed, na.rm=T),
                       Refed.Weight = mean(refed, na.rm=T),                       
                       Loss = mean(Loss, na.rm=T), 
                       Loss.pct = mean(Loss.pct, na.rm=T),
                       Gain = mean(Gain, na.rm=T), 
                       Gain.pct = mean(Gain.pct, na.rm=T))

summary.se.cohort <- ddply(weight.data, .(Treatment,Cohort), summarize,
                       Fasted.Weight = se(fasted),
                       Fed.Weight = se(fed),
                       Refed.Weight = se(refed),                    
                       Loss = se(Loss), 
                       Loss.pct = se(Loss.pct),
                       Gain = se(Gain), 
                       Gain.pct = se(Gain.pct))
```

```{r fasting-diet-abs-cohort, dev=c('png','pdf'), echo=FALSE}
max <- max(summary.means.cohort$Loss + summary.se.cohort$Loss)
colors_cohort <- c(rep(fasting_palette[1], 2), rep(fasting_palette[2], 4), rep(fasting_palette[3],2))
plot <- barplot(summary.means.cohort$Loss,
                ylab = "Fasting Induced Change in Body Weight (g)",
                beside=T,las=2,col=colors_cohort,
                names.arg = summary.means.cohort$Cohort,
                ylim = c(0,max))

superpose.eb(plot, 
             summary.means.cohort$Loss, 
             summary.se.cohort$Loss)

legend("top", levels(summary.means.cohort$Treatment), fill=fasting_palette, bty="n")
```

```{r fasting-diet-pct-cohort, dev=c('png','pdf'), echo=FALSE}
max <- max(summary.means.cohort$Loss.pct + summary.se.cohort$Loss.pct)
colors_cohort <- c(rep(fasting_palette[1], 2), rep(fasting_palette[2], 4), rep(fasting_palette[3],2))
plot <- barplot(summary.means.cohort$Loss.pct,
                ylab = "Fasting Induced Change in Body Weight (% Change)",
                beside=T,las=2,col=colors_cohort,
                names.arg = summary.means.cohort$Cohort,
                ylim = c(0,max))

superpose.eb(plot, 
             summary.means.cohort$Loss.pct, 
             summary.se.cohort$Loss.pct)

legend("top", levels(summary.means.cohort$Treatment), fill=fasting_palette, bty="n")
```

### Weight Gain During Refeeding Phase

#### Absolute Weight Gain 

We checked based on the ANOVA analysis whether the residuals were equally distributed.  For absolute weight loss, the p-value from the Shapiro-Wilk test was `r shapiro.test(residuals(gain.anova))$p.value` so therefore an ANOVA was **not** appropriate.  The p-value for the Kruskal-Wallis test was `r gain.kw$p.value`.  Pairwise Wilcoxon tests are shown below:

```{r wilcox-gain-abs, warning=FALSE, echo=FALSE}
pairwise.wilcox.test(weight.data$Gain,weight.data$Treatment, method="BH")
```

```{r refeeding-diet-abs, dev=c('png','pdf'), echo=FALSE}
max <- max(summary.means$Gain + summary.se$Gain)
plot <- barplot(summary.means$Gain,
                ylab = "Re-Feeding Induced Change in Body Weight (g)",
                beside=T,las=1,col=fasting_palette,
                names.arg = summary.means$Treatment,
                ylim = c(0,max))

superpose.eb(plot, 
             summary.means$Gain, 
             summary.se$Gain)
```

#### Relative Weight Gain 

We checked based on the ANOVA analysis whether the residuals were equally distributed.  For absolute weight loss, the p-value from the Shapiro-Wilk test was `r shapiro.test(residuals(gain.pct.anova))$p.value` so therefore an ANOVA was **not** appropriate.  The p-value for the Kruskal-Wallis test was `r gain.pct.kw$p.value`.  Pairwise Wilcoxon tests are shown below:

```{r wilcox-gain-pct, warning=FALSE, echo=FALSE}
pairwise.wilcox.test(weight.data$Gain.pct,weight.data$Treatment, method="BH")
```

```{r refeeding-diet-pct, dev=c('png','pdf'), echo=FALSE}
max <- max(summary.means$Gain.pct + summary.se$Gain.pct)
plot <- barplot(summary.means$Gain.pct,
                ylab = "Re-Feeding Induced Change in Body Weight (% Change)",
                beside=T,las=1,col=fasting_palette,
                names.arg = summary.means$Treatment,
                ylim = c(0,max))

superpose.eb(plot, 
             summary.means$Gain.pct, 
             summary.se$Gain.pct)
```

Comparason of Fasting Induced Weight Loss to Eventual Weight Gain
--------------------------------------------------------------------

Due to the stability in percent weight loss even without dietary manipulation, we wanted to test for associations between fasting induced-weight loss and their eventual weight gain during dietary manipulation.

```{r linear-modeling-gain, echo=FALSE, warning=FALSE}
#calculated correlation coefficients
gain.cor.abs <- with(cohort5.6.data, cor.test(Gain,Early, method="spearman"))
gain.cor.pct <- with(cohort5.6.data, cor.test(Gain.pct,Early.pct, method="spearman"))

gain.lm.abs <- lm(Gain~Treatment+Early, data=cohort5.6.data)
gain.lm.abs.int <- lm(Gain~Treatment*Early, data=cohort5.6.data)
gain.lm.pct <- lm(Gain.pct~Treatment+Early.pct, data=cohort5.6.data)
gain.lm.pct.int <- lm(Gain.pct~Treatment*Early.pct, data=cohort5.6.data)

gain.cor.abs.hfd <- with(subset(cohort5.6.data, Treatment=="High Fat Diet"), cor.test(Early, Gain, method="spearman"))
gain.cor.abs.cd <- with(subset(cohort5.6.data, Treatment=="Control Diet"), cor.test(Early, Gain, method="spearman"))

gain.cor.pct.hfd <- with(subset(cohort5.6.data, Treatment=="High Fat Diet"), cor.test(Early.pct, Gain.pct, method="spearman"))
gain.cor.pct.cd <- with(subset(cohort5.6.data, Treatment=="Control Diet"), cor.test(Early.pct, Gain.pct, method="spearman"))

aov.model.null <- lm(Gain.pct~Treatment, data=cohort5.6.data)

model.improvement <- add1(aov.model.null, ~ Treatment * Early.pct, test="F")$`Pr(>F)`[2]
```

We next tested whether weight loss pre-diet has any effect on weight loss later on.  When combined, since there should be no difference in the groups pre-diet the data were normall distributed (p=`r shapiro.test(cohort5.6.data$Early)$p.value` for absolute weight loss and p=`r shapiro.test(cohort5.6.data$Early.pct)$p.value` for percent weight loss).  Log-transforming these data yielded normal distributions (p=`r shapiro.test(log(cohort5.6.data$Early))$p.value` for absolute weight loss and p=`r shapiro.test(log(cohort5.6.data$Early.pct))$p.value` for percent weight loss).

For log transformed Control Diet pre-diet fasting values, the Shapiro-Wilk test had a p-value of `r shapiro.test(log(cohort5.6.data[cohort5.6.data$Treatment=="Control Diet",]$Early))$p.value` for absolute weight loss and `r shapiro.test(log(cohort5.6.data[cohort5.6.data$Treatment=="Control Diet",]$Early.pct))$p.value` for relative weight loss. For log transformed High Fat Diet pre-diet values, the Shapiro-Wilk test had a p-value of `r shapiro.test(log(cohort5.6.data[cohort5.6.data$Treatment=="High Fat Diet",]$Early))$p.value` for absolute weight loss and `r shapiro.test(log(cohort5.6.data[cohort5.6.data$Treatment=="High Fat Diet",]$Early.pct))$p.value` for relative weight loss.

At the end of the diet, the percent weight gain and absolute weight gain was also not normally distributed (p=`r shapiro.test(cohort5.6.data[cohort5.6.data$Treatment=="High Fat Diet",]$Gain.pct)$p.value` and `r shapiro.test(cohort5.6.data[cohort5.6.data$Treatment=="High Fat Diet",]$Gain)$p.value`) for High Fat Diet.  For Control Diet, the data was normally distributed for percent weight gain (p=`r shapiro.test(cohort5.6.data[cohort5.6.data$Treatment=="Control Diet",]$Gain.pct)$p.value`) but not absolute weight gain (p=`r shapiro.test(cohort5.6.data[cohort5.6.data$Treatment=="Control Diet",]$Gain)$p.value`).  The log transformed Shapiro-tests were (p=`r shapiro.test(log(cohort5.6.data[cohort5.6.data$Treatment=="High Fat Diet",]$Gain.pct))$p.value` and `r shapiro.test(log(cohort5.6.data[cohort5.6.data$Treatment=="High Fat Diet",]$Gain))$p.value`) for High Fat Diet and (p=`r shapiro.test(log(cohort5.6.data[cohort5.6.data$Treatment=="Control Diet",]$Gain.pct))$p.value` and `r shapiro.test(log(cohort5.6.data[cohort5.6.data$Treatment=="Control Diet",]$Gain))$p.value`) for Control Diet.  This was due to a bimodal distribution for the gain in high fat diet and cannot be accounted for by a transformation, as shown below:

```{r gain-density-plot,fig=TRUE,echo=FALSE, dev=c('png','pdf')}
par(mfrow=c(1,2))
plot(density(cohort5.6.data[cohort5.6.data$Treatment=="High Fat Diet",]$Gain.pct, na.rm=T), col=palette()[2],
     main="", xlab="Percent Weight Gain on Diet", las=2)
lines(density(cohort5.6.data[cohort5.6.data$Treatment=="Control Diet",]$Gain.pct, na.rm=T), col=palette()[1])
legend("topleft", levels(cohort5.6.data$Treatment), col=palette()[1:2], lty=1, pch=19, bty="n")

plot(density(cohort5.6.data[cohort5.6.data$Treatment=="High Fat Diet",]$Gain, na.rm=T), col=palette()[2],
     main="", xlab="Absolute Weight Gain on Diet (g)", las=2)
lines(density(cohort5.6.data[cohort5.6.data$Treatment=="Control Diet",]$Gain, na.rm=T), col=palette()[1])
legend("topleft", levels(cohort5.6.data$Treatment), col=palette()[1:2], lty=1, pch=19, bty="n")
```

The question, we asked is whether is weight loss consistent within animals, based on a Spearman's Rank Order Test. There was a strong correlation between percentage weight loss pre-diet and weight gained during the diet (r=`r round(gain.cor.pct$estimate,3)`, R2=`r round(gain.cor.pct$estimate^2,3)`, p=`r round(gain.cor.pct$p.value,6)`) and also absolute weight loss relative to absolute weight gain (r=`r round(gain.cor.abs$estimate,3)`, R2=`r round(gain.cor.abs$estimate^2,3)`, p=`r round(gain.cor.abs$p.value,5)`).  These data are graphed below.

To account for the potential confounding effect of dietary treatment, we generated linear models comparing early weight loss to weight gain in absolute or relative terms.   These models had an adjusted R2 of `r round(summary(gain.lm.abs)$r.squared,3)` for absolute weight gain and `r round(summary(gain.lm.pct)$r.squared,3)` for percentage weight gain. There was no interaction between the treatment and the early fasting induced weight loss in either absolute (p=`r round(anova(gain.lm.abs, gain.lm.abs.int)$"Pr(>F)"[2],3)`) but there was an interaction in percent terms (p=`r round(anova(gain.lm.pct, gain.lm.pct.int)$"Pr(>F)"[2],3)`).

Because of this, we separated out the diets and looked at correlations between absolute weight gain on high fat diet and pre-diet absolute weight loss (Rho=`r round(gain.cor.abs.hfd$estimate,3)`, Rho<sup>2</sup>=`r round(gain.cor.abs.hfd$estimate^2,3)`, p=`r round(gain.cor.abs.hfd$p.value,6)`) and for control diet  (r=`r round(gain.cor.abs.cd$estimate,3)`, R2=`r round(gain.cor.abs.cd$estimate^2,3)`, p=`r round(gain.cor.abs.cd$p.value,6)`).

In terms of percentage weight gain (relative to percent pre-diet fasting response) we observed for high fat diet (r`r round(gain.cor.pct.hfd$estimate,3)`, R2=`r round(gain.cor.pct.hfd$estimate^2,3)`, p=`r round(gain.cor.pct.hfd$p.value,10)`) and for control diet  (r=`r round(gain.cor.pct.cd$estimate,3)`, R2=`r round(gain.cor.pct.cd$estimate^2,3)`, p=`r round(gain.cor.pct.cd$p.value,10)`).

  These correlation coefficients are summarized below:

```{r gain-correlation-tables,echo=FALSE,results='asis', message=FALSE, warning=FALSE}
gain.correlation.table <- data.frame()
#fill in table
gain.correlation.table["HFD - Absolute Weight Gain (Rho)","Pre Diet Relative Fasting Response"] <- with(subset(cohort5.6.data, Treatment=="High Fat Diet"), cor.test(Early.pct, Gain, method="spearman"))$estimate
gain.correlation.table["HFD - Absolute Weight Gain (Rho)", "Pre Diet Absolute Fasting Response"] <- with(subset(cohort5.6.data, Treatment=="High Fat Diet"), cor.test(Early, Gain, method="spearman"))$estimate
gain.correlation.table["HFD - Absolute Weight Gain (p.value)", "Pre Diet Relative Fasting Response"] <- with(subset(cohort5.6.data, Treatment=="High Fat Diet"), cor.test(Early.pct, Gain, method="spearman"))$p.value
gain.correlation.table["HFD - Absolute Weight Gain (p.value)", "Pre Diet Absolute Fasting Response"] <- with(subset(cohort5.6.data, Treatment=="High Fat Diet"), cor.test(Early, Gain, method="spearman"))$p.value
gain.correlation.table["HFD - Relative Weight Gain (Rho)","Pre Diet Relative Fasting Response"] <- with(subset(cohort5.6.data, Treatment=="High Fat Diet"), cor.test(Early.pct, Gain.pct, method="spearman"))$estimate
gain.correlation.table["HFD - Relative Weight Gain (Rho)", "Pre Diet Absolute Fasting Response"] <- with(subset(cohort5.6.data, Treatment=="High Fat Diet"), cor.test(Early, Gain.pct, method="spearman"))$estimate
gain.correlation.table["HFD - Relative Weight Gain (p.value)", "Pre Diet Relative Fasting Response"] <- with(subset(cohort5.6.data, Treatment=="High Fat Diet"), cor.test(Early.pct, Gain.pct, method="spearman"))$p.value
gain.correlation.table["HFD - Relative Weight Gain (p.value)", "Pre Diet Absolute Fasting Response"] <- with(subset(cohort5.6.data, Treatment=="High Fat Diet"), cor.test(Early, Gain.pct, method="spearman"))$p.value
#for CD
gain.correlation.table["CD - Absolute Weight Gain (Rho)","Pre Diet Relative Fasting Response"] <- with(subset(cohort5.6.data, Treatment=="Control Diet"), cor.test(Early.pct, Gain, method="spearman"))$estimate
gain.correlation.table["CD - Absolute Weight Gain (Rho)", "Pre Diet Absolute Fasting Response"] <- with(subset(cohort5.6.data, Treatment=="Control Diet"), cor.test(Early, Gain, method="spearman"))$estimate
gain.correlation.table["CD - Absolute Weight Gain (p.value)", "Pre Diet Relative Fasting Response"] <- with(subset(cohort5.6.data, Treatment=="Control Diet"), cor.test(Early.pct, Gain, method="spearman"))$p.value
gain.correlation.table["CD - Absolute Weight Gain (p.value)", "Pre Diet Absolute Fasting Response"] <- with(subset(cohort5.6.data, Treatment=="Control Diet"), cor.test(Early, Gain, method="spearman"))$p.value
gain.correlation.table["CD - Relative Weight Gain (Rho)","Pre Diet Relative Fasting Response"] <- with(subset(cohort5.6.data, Treatment=="Control Diet"), cor.test(Early.pct, Gain.pct, method="spearman"))$estimate
gain.correlation.table["CD - Relative Weight Gain (Rho)", "Pre Diet Absolute Fasting Response"] <- with(subset(cohort5.6.data, Treatment=="Control Diet"), cor.test(Early, Gain.pct, method="spearman"))$estimate
gain.correlation.table["CD - Relative Weight Gain (p.value)", "Pre Diet Relative Fasting Response"] <- with(subset(cohort5.6.data, Treatment=="Control Diet"), cor.test(Early.pct, Gain.pct, method="spearman"))$p.value
gain.correlation.table["CD - Relative Weight Gain (p.value)", "Pre Diet Absolute Fasting Response"] <- with(subset(cohort5.6.data, Treatment=="Control Diet"), cor.test(Early, Gain.pct, method="spearman"))$p.value
#write to results fule
write.csv(gain.correlation.table, "../data/processed/Correlations Between Fasting Response and Weight Gain.csv")
print(xtable(gain.correlation.table, caption = "Spearman's Rho and p-values for each comparason between weight gain and fasting responses", label = "tab:gain-correlations", digits=4), type="html")
```

Alternatively we generated a model where percent weight gain is dependent only on the treatment.  We then performed a F-test to see if inclusion of the pre-diet improved the model.  In this case it does, with a p-value of **`r round(model.improvement,10)`**.

```{r gain-plot,fig=TRUE,echo=FALSE, dev=c('png','pdf')}
with(cohort5.6.data, plot(Early,Gain, col=Treatment, pch=19,las=1,
                        xlab="Pre-Diet Weight Loss (g)",
                        ylab="Weight Gained During Diet (g)",
                        xlim=c(0,max(Early, na.rm=T)),
                        ylim=c(0,max(Gain, na.rm=T))
                      ))
with(subset(cohort5.6.data, Treatment=="Control Diet"), abline(lm(Gain~Early), col=palette()[1]))
with(subset(cohort5.6.data, Treatment=="High Fat Diet"), abline(lm(Gain~Early), col=palette()[2]))
legend("topleft", levels(cohort5.6.data$Treatment), col=palette()[1:2], lty=1, pch=19, bty="n")
```

```{r gain-plot-pct,fig=TRUE,echo=FALSE, dev=c('png','pdf')}
with(cohort5.6.data, plot(Early.pct,Gain.pct, col=Treatment, pch=19,las=1,
                        xlab="Pre-Diet Weight Loss (% of Fed)",
                        ylab="Weight Gain During Diet (% of Initial)",
                        xlim=c(0,max(Early.pct, na.rm=T)),
                        ylim=c(0,max(Gain.pct, na.rm=T))
                      ))
with(subset(cohort5.6.data, Treatment=="Control Diet"), abline(lm(Gain.pct~Early.pct), col=palette()[1]))
with(subset(cohort5.6.data, Treatment=="High Fat Diet"), abline(lm(Gain.pct~Early.pct), col=palette()[2]))
legend("topleft", levels(cohort5.6.data$Treatment), col=palette()[1:2], lty=1, pch=19, bty="n")
```

```{r gain-plot-all,fig=TRUE,echo=FALSE, dev=c('png','pdf')}
par(mfrow=c(2,2))
with(cohort5.6.data, plot(Early.pct,Gain.pct, col=Treatment, pch=19,las=1,
                        xlab="Pre-Diet Weight Loss (% of Fed)",
                        ylab="Weight Gain During Diet (% of Initial)",
                        xlim=c(0,max(Early.pct, na.rm=T)),
                        ylim=c(0,max(Gain.pct, na.rm=T))
                      ))
with(subset(cohort5.6.data, Treatment=="Control Diet"), abline(lm(Gain.pct~Early.pct), col=palette()[1]))
with(subset(cohort5.6.data, Treatment=="High Fat Diet"), abline(lm(Gain.pct~Early.pct), col=palette()[2]))
legend("bottomleft", levels(cohort5.6.data$Treatment), col=palette()[1:2], lty=1, pch=19, bty="n")

with(cohort5.6.data, plot(Early.pct,Gain, col=Treatment, pch=19,las=1,
                        xlab="Pre-Diet Weight Loss (% of Fed)",
                        ylab="Weight Gain During Diet (g)",
                        xlim=c(0,max(Early.pct, na.rm=T)),
                        ylim=c(0,max(Gain, na.rm=T))
                      ))
with(subset(cohort5.6.data, Treatment=="Control Diet"), abline(lm(Gain~Early.pct), col=palette()[1]))
with(subset(cohort5.6.data, Treatment=="High Fat Diet"), abline(lm(Gain~Early.pct), col=palette()[2]))

with(cohort5.6.data, plot(Early,Gain.pct, col=Treatment, pch=19,las=1,
                        xlab="Pre-Diet Weight Loss (g)",
                        ylab="Weight Gain During Diet (% of Initial)",
                        xlim=c(0,max(Early, na.rm=T)),
                        ylim=c(0,max(Gain.pct, na.rm=T))
                      ))
with(subset(cohort5.6.data, Treatment=="Control Diet"), abline(lm(Gain.pct~Early), col=palette()[1]))
with(subset(cohort5.6.data, Treatment=="High Fat Diet"), abline(lm(Gain.pct~Early), col=palette()[2]))

with(cohort5.6.data, plot(Early,Gain, col=Treatment, pch=19,las=1,
                        xlab="Pre-Diet Weight Loss (g)",
                        ylab="Weight Gain During Diet (g)",
                        xlim=c(0,max(Early, na.rm=T)),
                        ylim=c(0,max(Gain, na.rm=T))
                      ))
with(subset(cohort5.6.data, Treatment=="Control Diet"), abline(lm(Gain~Early), col=palette()[1]))
with(subset(cohort5.6.data, Treatment=="High Fat Diet"), abline(lm(Gain~Early), col=palette()[2]))
```

### Checking for Cohort Effects on Relationship Between Pre-Diet Fasting Response and Weight Gain

We tested whether each cohort was independently significant.  We did Spearman Rank Order tests on each cohort independently.

```{r gain-cohorts, echo=FALSE, message=FALSE,results='asis'}
gain.cohort <- data.frame(row.names=c("Cohort 5 Absolute", "Cohort 5 Relative", "Cohort 6 Absolute", "Cohort 6 Relative"))

gain.cohort['Cohort 5 Relative','pval-cd'] <- with(subset(cohort5.6.data, Treatment=="Control Diet"&Cohort=="Cohort 5"), cor.test(Early.pct,Gain.pct)$p.value)
gain.cohort['Cohort 5 Relative','Rho-cd'] <- with(subset(cohort5.6.data, Treatment=="Control Diet"&Cohort=="Cohort 5"), cor.test(Early.pct,Gain.pct)$estimate)
gain.cohort['Cohort 5 Relative','Rho^2-cd'] <- with(subset(cohort5.6.data, Treatment=="Control Diet"&Cohort=="Cohort 5"), cor.test(Early.pct,Gain.pct)$estimate^2)

gain.cohort['Cohort 5 Relative','pval-hfd'] <- with(subset(cohort5.6.data, Treatment=="High Fat Diet"&Cohort=="Cohort 5"), cor.test(Early.pct,Gain.pct)$p.value)
gain.cohort['Cohort 5 Relative','Rho-hfd'] <- with(subset(cohort5.6.data, Treatment=="High Fat Diet"&Cohort=="Cohort 5"), cor.test(Early.pct,Gain.pct)$estimate)
gain.cohort['Cohort 5 Relative','Rho^2-hfd'] <- with(subset(cohort5.6.data, Treatment=="High Fat Diet"&Cohort=="Cohort 5"), cor.test(Early.pct,Gain.pct)$estimate^2)

gain.cohort['Cohort 6 Relative','pval-cd'] <- with(subset(cohort5.6.data, Treatment=="Control Diet"&Cohort=="Cohort 6"), cor.test(Early.pct,Gain.pct)$p.value)
gain.cohort['Cohort 6 Relative','Rho-cd'] <- with(subset(cohort5.6.data, Treatment=="Control Diet"&Cohort=="Cohort 6"), cor.test(Early.pct,Gain.pct)$estimate)
gain.cohort['Cohort 6 Relative','Rho^2-cd'] <- with(subset(cohort5.6.data, Treatment=="Control Diet"&Cohort=="Cohort 6"), cor.test(Early.pct,Gain.pct)$estimate^2)

gain.cohort['Cohort 6 Relative','pval-hfd'] <- with(subset(cohort5.6.data, Treatment=="High Fat Diet"&Cohort=="Cohort 6"), cor.test(Early.pct,Gain.pct)$p.value)
gain.cohort['Cohort 6 Relative','Rho-hfd'] <- with(subset(cohort5.6.data, Treatment=="High Fat Diet"&Cohort=="Cohort 6"), cor.test(Early.pct,Gain.pct)$estimate)
gain.cohort['Cohort 6 Relative','Rho^2-hfd'] <- with(subset(cohort5.6.data, Treatment=="High Fat Diet"&Cohort=="Cohort 6"), cor.test(Early.pct,Gain.pct)$estimate^2)

gain.cohort['Cohort 5 Absolute','pval-cd'] <- with(subset(cohort5.6.data, Treatment=="Control Diet"&Cohort=="Cohort 5"), cor.test(Early,Gain)$p.value)
gain.cohort['Cohort 5 Absolute','Rho-cd'] <- with(subset(cohort5.6.data, Treatment=="Control Diet"&Cohort=="Cohort 5"), cor.test(Early,Gain)$estimate)
gain.cohort['Cohort 5 Absolute','Rho^2-cd'] <- with(subset(cohort5.6.data, Treatment=="Control Diet"&Cohort=="Cohort 5"), cor.test(Early,Gain)$estimate^2)

gain.cohort['Cohort 5 Absolute','pval-hfd'] <- with(subset(cohort5.6.data, Treatment=="High Fat Diet"&Cohort=="Cohort 5"), cor.test(Early,Gain)$p.value)
gain.cohort['Cohort 5 Absolute','Rho-hfd'] <- with(subset(cohort5.6.data, Treatment=="High Fat Diet"&Cohort=="Cohort 5"), cor.test(Early,Gain)$estimate)
gain.cohort['Cohort 5 Absolute','Rho^2-hfd'] <- with(subset(cohort5.6.data, Treatment=="High Fat Diet"&Cohort=="Cohort 5"), cor.test(Early,Gain)$estimate^2)

gain.cohort['Cohort 6 Absolute','pval-cd'] <- with(subset(cohort5.6.data, Treatment=="Control Diet"&Cohort=="Cohort 6"), cor.test(Early,Gain)$p.value)
gain.cohort['Cohort 6 Absolute','Rho-cd'] <- with(subset(cohort5.6.data, Treatment=="Control Diet"&Cohort=="Cohort 6"), cor.test(Early,Gain)$estimate)
gain.cohort['Cohort 6 Absolute','Rho^2-cd'] <- with(subset(cohort5.6.data, Treatment=="Control Diet"&Cohort=="Cohort 6"), cor.test(Early,Gain)$estimate^2)

gain.cohort['Cohort 6 Absolute','pval-hfd'] <- with(subset(cohort5.6.data, Treatment=="High Fat Diet"&Cohort=="Cohort 6"), cor.test(Early,Gain)$p.value)
gain.cohort['Cohort 6 Absolute','Rho-hfd'] <- with(subset(cohort5.6.data, Treatment=="High Fat Diet"&Cohort=="Cohort 6"), cor.test(Early,Gain)$estimate)
gain.cohort['Cohort 6 Absolute','Rho^2-hfd'] <- with(subset(cohort5.6.data, Treatment=="High Fat Diet"&Cohort=="Cohort 6"), cor.test(Early,Gain)$estimate^2)

print(xtable(gain.cohort, caption="Correlations between pre-diet fasting response and weight gain per cohort", digits=4), type="html")
```

```{r gain-plot-pct-cohorts,fig=TRUE,echo=FALSE, dev=c('png','pdf')}
par(mfrow=c(1,2))
for (cohort in levels(cohort5.6.data$Cohort)){
with(subset(cohort5.6.data, Cohort==cohort), plot(Early.pct,Gain.pct, col=Treatment, pch=19,las=1,
                        xlab="Pre-Diet Weight Loss (% of Fed)",
                        main=cohort,
                        ylab="Weight Gain During Diet (% of Initial)",
                        xlim=c(0,max(Early.pct, na.rm=T)),
                        ylim=c(0,max(Gain.pct, na.rm=T))
                      ))
with(subset(cohort5.6.data, Cohort==cohort&Treatment=="Control Diet"), abline(lm(Gain.pct~Early.pct), col=palette()[1]))
with(subset(cohort5.6.data, Cohort==cohort&Treatment=="High Fat Diet"), abline(lm(Gain.pct~Early.pct), col=palette()[2]))
legend("topleft", levels(cohort5.6.data$Treatment), col=palette()[1:2], lty=1, pch=19, bty="n")
}
```

```{r gain-plot-cohorts,fig=TRUE,echo=FALSE, dev=c('png','pdf')}
par(mfrow=c(1,2))
for (cohort in levels(cohort5.6.data$Cohort)){
with(subset(cohort5.6.data, Cohort==cohort), plot(Early,Gain, col=Treatment, pch=19,las=1,
                        xlab="Pre-Diet Weight Loss (g)",
                        main=cohort,
                        ylab="Weight Gain During Diet (g)",
                        xlim=c(0,max(Early, na.rm=T)),
                        ylim=c(0,max(Gain, na.rm=T))
                      ))
with(subset(cohort5.6.data, Cohort==cohort&Treatment=="Control Diet"), abline(lm(Gain~Early), col=palette()[1]))
with(subset(cohort5.6.data, Cohort==cohort&Treatment=="High Fat Diet"), abline(lm(Gain~Early), col=palette()[2]))
legend("topleft", levels(cohort5.6.data$Treatment), col=palette()[1:2], lty=1, pch=19, bty="n")
}
```

Session Information
--------------------

```{r wessionInfo, echo=F}
sessionInfo()
```

