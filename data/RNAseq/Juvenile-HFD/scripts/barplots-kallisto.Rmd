
---
title: "Barplot Analysis of Juvenile HFD Study"
author: "Dave Bridges"
date: "August 13, 2015"
output:
  html_document:
    keep_md: true
---

```{r global_options}
library(knitr)
opts_chunk$set(fig.path='figures/',
               echo=FALSE, warning=FALSE, message=FALSE,dev=c('png','pdf'))
options(digits=3, scipen=8)
```

Used analysed DESeq results.  This script was most recently run on `r date()`.

```{r file-input}
filename <- "TPM Table.csv"
deseq.filename.wat <- "DESeq Results for Effects of Diet on WAT - Kalllisto.csv"
deseq.filename.quad <- "DESeq Results for Effects of Diet on Quadriceps - Kalllisto.csv"
mapping.filename <- "../sample-mapping.csv"
annotation.filename <- "ENSEMBL Annotation - Transcripts.csv"
#read in the file
normalized.data <- read.csv(filename, row.names='X')
deseq.data.wat <- read.csv(deseq.filename.wat)
deseq.data.quad <- read.csv(deseq.filename.quad)
mapping <- read.csv(mapping.filename)
mapping$samplename <- paste("sample", mapping$sample.., sep="")
mapping$Diet <- relevel(mapping$Diet, ref="Control Diet")
annotation <- read.csv(annotation.filename, row.names="X")
```

This script uses the DESeq files `r deseq.filename.wat` and the mapping file `r mapping.filename`.  It uses the annotation data found in `r annotation.filename`.  The normalized counts are found in `r filename`.

# Adipocytes

```{r adipose-data}
#get columns for adipose data
adipose.normalized.data <- normalized.data[,levels(droplevels(subset(mapping, Tissue=="eWAT")$Barcode))]
#remove decimal from gene name
adipose.normalized.data$ensembl_transcript_id <- as.character(lapply(strsplit(rownames(adipose.normalized.data), "\\."), "[[", 1))

rpkm.data <- merge(adipose.normalized.data, annotation, by='ensembl_transcript_id') 
rpkm.data.unique <- rpkm.data

rownames(rpkm.data.unique) <- rpkm.data.unique$ensembl_transcript_id
rpkm.data.unique <- rpkm.data.unique
library(tidyr)
library(dplyr)
#set genes for single barplots
#genes.of.interest <- c("Retn","Pparg","Lep","Hsd11b1","Pnpla2","Tbc1d9b","Clk4","Slc1a3","Ap2s1","Rer1","Ywhae","Eif4ebp3","Hsd11b1","Irf4")

GR_activator <- c("Ncoa1", "Ncoa2", "Ncoa3")

#get transcript names from the gene list
get_toi <- function(goi){
  toi <- as.character(droplevels(subset(annotation, external_gene_name %in% goi)$ensembl_transcript_id))
  return(toi)
}
#get data from the transcript of interest
get_goi_data <- function (data, trans_interest) {
  goi.data <- data[trans_interest,]
  return(goi.data)
}

#put the data in long format
get_long_format <- function(goi.data.wide){
    genes.of.interest.long <- 
      goi.data.wide %>%
      select(-gene_biotype, -ensembl_gene_id) %>%
      gather(SampleID, expression, -external_gene_name, -ensembl_transcript_id)
    goi.long <- droplevels(merge(mapping, genes.of.interest.long, by.x="Barcode", by.y="SampleID"))
  
  goi.long.cal <- 
    goi.long %>%
    group_by(external_gene_name, ensembl_transcript_id, Feeding,Diet) %>%
    summarize(Average = mean(expression),
              SE = sd(expression)/sqrt(length(expression)))
  return(goi.long.cal)
}
transcript_GR_activator <- get_toi(GR_activator)
goi.dat <- get_goi_data(rpkm.data.unique, transcript_GR_activator)
goi.long.cal.wat <- get_long_format(goi.dat)
```

# Quadriceps

```{r quadriceps-data}
#get columns for quad data
quad.normalized.data <- normalized.data[,levels(droplevels(subset(mapping, Tissue=="Quadriceps")$Barcode))]
#remove decimal from gene name
quad.normalized.data$ensembl_transcript_id <- as.character(lapply(strsplit(rownames(quad.normalized.data), "\\."), "[[", 1))

rpkm.data.quad <- merge(quad.normalized.data, annotation, by='ensembl_transcript_id') 
rpkm.data.unique.quad <- rpkm.data.quad

rownames(rpkm.data.unique.quad) <- rpkm.data.unique.quad$ensembl_transcript_id
rpkm.data.unique.quad <- rpkm.data.unique.quad

#get a table of just the genes of interest
goi.data.quad <- get_goi_data(rpkm.data.unique.quad, transcript_GR_activator)
#put the data in long format
goi.long.cal.quad <- get_long_format(goi.data.quad)
```


Drew bargraphs for *`r paste(GR_activator, collapse=", ")`*.

```{r barplots, echo=FALSE, fig.show='asis', dev='pdf'}
library(ggplot2)
draw_barplot<- function(goi.long.wat, goi.long.quad){
  for (transcript in goi.long.wat$ensembl_transcript_id[!(is.na(goi.long.wat$ensembl_transcript_id))]) {
    gene.data.adipose <- subset(goi.long.wat, ensembl_transcript_id==transcript)
    gene.data.quad <- subset(goi.long.quad, ensembl_transcript_id==transcript)
    p <- ggplot(gene.data.adipose, aes(x=Diet,y=Average,fill=Feeding))
    q <- ggplot(gene.data.quad,  aes(x=Diet,y=Average,fill=Feeding))
    dodge <- position_dodge(width=0.9)
    p + geom_bar(position=dodge, stat="identity") +
       geom_errorbar(aes(ymin=Average-SE, ymax=Average+SE), position=dodge, width=0.1) +
       xlab("") + ylab("mRNA Expression (RPKM)")+ 
       theme_bw() + ggtitle(paste("eWAT", as.character(gene.data.adipose$external_gene_name[1]), transcript, sep="-")) + 
       theme(panel.grid.minor = element_blank()) + theme(panel.grid.major = element_blank()) + 
       theme(panel.border=element_blank()) + scale_x_discrete(labels=gene.data.adipose$Diet) + 
       theme(axis.line = element_line(color = 'black'))+scale_colour_grey(start = 0.5, end = .9)
    ggsave(filename=paste('figures/barplots/Adipose-',
                          paste(as.character(gene.data.adipose$external_gene_name[1]), transcript, sep="-")
                          ,'-barplot-kallisto.pdf',sep=""))
    
    q + geom_bar(position=dodge, stat="identity") +
       geom_errorbar(aes(ymin=Average-SE, ymax=Average+SE), position=dodge, width=0.1) +
       xlab("") + ylab("mRNA Expression (RPKM)")+ 
       theme_bw() + ggtitle(paste("Quad", as.character(gene.data.quad$external_gene_name[1]), transcript, sep="-")) + 
       theme(panel.grid.minor = element_blank()) + theme(panel.grid.major = element_blank()) + 
       theme(panel.border=element_blank()) + scale_x_discrete(labels=gene.data.quad$Diet) + 
       theme(axis.line = element_line(color = 'black'))+scale_colour_grey(start = 0.5, end = .9)
    ggsave(filename=paste('figures/barplots/Quadriceps-',
                          paste(as.character(gene.data.quad$external_gene_name[1]), transcript, sep="-")
                          ,'-barplot-kallisto.pdf',sep=""))
  }
}

draw_barplot(goi.long.cal.wat, goi.long.cal.quad)
```

Session Information
---------------------

```{r session-information}
sessionInfo()
```
