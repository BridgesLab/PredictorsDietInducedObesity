---
title: "DESeq Analysis"
author: "Dave Bridges"
date: "August 2, 2015"
output:
  html_document:
    keep_md: true
---


```{r global_options, include=FALSE}
library(knitr)
opts_chunk$set(fig.path='figures/',
               echo=FALSE, warning=FALSE, message=FALSE,dev=c('png','pdf'))
options(digits=3, scipen=8)
```

This script performs the DESeq analyses on the Juvenile HFD studies.  This script was most recently run on `r date()`

```{r data-entry}
input_folder <- '../server-scripts/htseq-output'
sample_table_file <- '../sample-mapping.csv'
sample_table <- read.csv(sample_table_file)
sample_table$Barcode <- paste(sample_table$Barcode, "counts.txt", sep="-")

annotation_file <- 'ENSEMBL Annotation.csv'
annotation <- read.csv(annotation_file)
```

The counts data, derived from HTSeq are located in `r input_folder`.  The sample mapping file is located in `r sample_table_file`.  The annotations are from the file `r annotation_file`.

```{r deseq}
library(DESeq2)
#for sampleTable each row describes one sample. The first column is the sample name, the second column the file name of the count file generated by htseq-count, and the remaining columns are sample metadata which will be stored in colData
dds.overall <- DESeqDataSetFromHTSeqCount(sampleTable = sample_table,
                                       directory = input_folder, 
                                       design= ~ Tissue * Feeding * Diet)
library(BiocParallel)
register(MulticoreParam(8))
dds.overall <- DESeq(dds.overall, parallel=T, betaPrior = F)
res.overall <- results(dds.overall, parallel=T)

counts_file <- 'Normalized Counts.csv'
write.csv(counts(dds.overall, normalized=T), counts_file)
#summary(res.overall)
```

# Overall Analysis

The first model was a completely interacting model in which tissue, feeding state and diet were all able to interact.

```{r deseq-MA-plot-overall, fig.cap="MA Plot for Overall Model"}
plotMA(res.overall, main="DESeq2", ylim=c(-4,4))
```

```{r deseq-PCA-plot-overall, fig.cap="PCA Plot for Overall Model"}
rld.overall <- rlog(dds.overall)
plotPCA(rld.overall, intgroup=c("Tissue", "Feeding","Diet"))
distsRL <- dist(t(assay(rld.overall)))
```

```{r deseq-similarity-matrix, fig.cap="Similarity Matrix for All Samples"}
library(gplots)
mat <- as.matrix(distsRL)
rownames(mat) <- colnames(mat) <- rownames(colData(dds.overall))
hc <- hclust(distsRL)
heatmap.2(mat, Rowv=as.dendrogram(hc),
symm=TRUE, trace="none")
```

# Adipose Tissue

The adipose tissue samples are all eWAT samples

## Effects of Feeding State

This model used only the adipose tissue data, and tested for changes related to the feeding state.

```{r wat-feeding}
dds.wat.feeding <- DESeqDataSetFromHTSeqCount(sampleTable = subset(sample_table, Tissue=="eWAT"),
                                       directory = input_folder, 
                                       design= ~ Feeding)

dds.wat.feeding <- DESeq(dds.wat.feeding, parallel=T, betaPrior = F)
res.wat.feeding <- results(dds.wat.feeding, parallel=T)
res.wat.feeding$ensembl_gene_id <- as.character(lapply(strsplit(rownames(res.wat.feeding), "\\."), "[[", 1))

annotated.res.wat.feeding <- merge(as.data.frame(res.wat.feeding), 
                          annotation, 
                          by='ensembl_gene_id',
                          all.x=T)
kable(head( annotated.res.wat.feeding[order(annotated.res.wat.feeding$padj),],5), caption="Top Hits for Effects of Feeding")
wat_feeding_results_file <- 'DESeq Results for Effects of Feeding on WAT.csv'
write.csv(annotated.res.wat.feeding, wat_feeding_results_file)
```

```{r deseq-MA-plot-wat-feeding, fig.cap="MA Plot for Effects of Feeding Status on Adipose Tissue"}
plotMA(res.wat.feeding, main="Adipose, Effects of Feeding", ylim=c(-4,4))
```

We identified `r table(res.wat.feeding$padj < 0.05)['TRUE']` differentially expressed genes in adipose tissue, out of a total of `r dim(res.wat.feeding)[1]` genes tested.  Of these significantly differentially expressed genes, `r table(res.wat.feeding$padj < 0.05, res.wat.feeding$log2FoldChange>0)['TRUE','TRUE']` were upregulated and `r table(res.wat.feeding$padj < 0.05, res.wat.feeding$log2FoldChange<0)['TRUE','TRUE']` were downregulated.

## Effects of Diet 

```{r wat-diet}
dds.wat <- DESeqDataSetFromHTSeqCount(
  sampleTable = subset(sample_table, Tissue=="eWAT"),
  directory = input_folder, 
  design = ~ Feeding + Diet + Feeding:Diet)

dds.wat <- DESeq(dds.wat,   test  = "LRT",
  full = ~  Feeding + Diet + Feeding:Diet,
  reduced = ~ Feeding,
  parallel= T)

res.wat <- results(dds.wat, parallel=T)
res.wat$log2FC_HFDvsControl <- results(dds.wat, name="DietHigh.Fat.Diet")$log2FoldChange
res.wat$lfcSE_HFDvsControl <- results(dds.wat, name="DietHigh.Fat.Diet")$lfcSE

res.wat$ensembl_gene_id <- as.character(lapply(strsplit(rownames(res.wat), "\\."), "[[", 1))

annotated.res.wat <- merge(as.data.frame(res.wat), 
                          annotation, 
                          by='ensembl_gene_id',
                          all.x=T)
kable(head( annotated.res.wat[order(annotated.res.wat$padj),],10), caption="Top Hits for Effects of Diet")
wat_diet_results_file <- 'DESeq Results for Effects of Diet on WAT.csv'
write.csv(annotated.res.wat, wat_diet_results_file)
```

```{r deseq-MA-plot-wat-diet, fig.cap="MA Plot for Effects of Diet Status on Adipose Tissue"}
plotMA(res.wat, main="Adipose, Effects of Diet", ylim=c(-10,10), las=1)
```

We identified `r table(res.wat$padj < 0.05)['TRUE']` differentially expressed genes, out of a total of `r dim(res.wat)[1]` genes tested.  Of these significantly differentially expressed genes, `r table(res.wat$padj < 0.05, res.wat$log2FoldChange>0)['TRUE','TRUE']` were upregulated and `r table(res.wat$padj < 0.05, res.wat$log2FoldChange<0)['TRUE','TRUE']` were downregulated.

# Muscle Tissue

The muscle tissue samples are all quadriceps samples

## Effects of Feeding State

This model used only the quadriceps tissue data, and tested for changes related to the feeding state.

```{r quad-feeding}
dds.quad.feeding <- DESeqDataSetFromHTSeqCount(sampleTable = subset(sample_table, Tissue=="Quadriceps"),
                                       directory = input_folder, 
                                       design= ~ Feeding)

dds.quad.feeding <- DESeq(dds.quad.feeding, parallel=T, betaPrior = F)
res.quad.feeding <- results(dds.quad.feeding, parallel=T)
res.quad.feeding$ensembl_gene_id <- as.character(lapply(strsplit(rownames(res.quad.feeding), "\\."), "[[", 1))

annotated.res.quad.feeding <- merge(as.data.frame(res.quad.feeding), 
                          annotation, 
                          by='ensembl_gene_id',
                          all.x=T)
kable(head( annotated.res.quad.feeding[order(annotated.res.quad.feeding$padj),],5), caption="Top Hits for Effects of Feeding")
quad_feeding_results_file <- 'DESeq Results for Effects of Feeding on Quadriceps.csv'
write.csv(annotated.res.quad.feeding, quad_feeding_results_file)
```

```{r deseq-MA-plot-quad-feeding, fig.cap="MA Plot for Effects of Feeding Status on Muscle Tissue"}
plotMA(res.quad.feeding, main="Muscle, Effects of Feeding", ylim=c(-4,4))
```

We identified `r table(res.quad.feeding$padj < 0.05)['TRUE']` differentially expressed genes in muscle tissue, out of a total of `r dim(res.quad.feeding)[1]` genes tested.  Of these significantly differentially expressed genes, `r table(res.quad.feeding$padj < 0.05, res.quad.feeding$log2FoldChange>0)['TRUE','TRUE']` were upregulated and `r table(res.quad.feeding$padj < 0.05, res.quad.feeding$log2FoldChange<0)['TRUE','TRUE']` were downregulated.

## Effects of Diet 

```{r quad-diet}
dds.quad <- DESeqDataSetFromHTSeqCount(
  sampleTable = subset(sample_table, Tissue=="Quadriceps"),
  directory = input_folder, 
  design = ~ Feeding + Diet + Feeding:Diet)

dds.quad <- DESeq(dds.quad,   test  = "LRT",
  full = ~  Feeding + Diet + Feeding:Diet,
  reduced = ~ Feeding,
  parallel= T)
res.quad <- results(dds.quad, parallel=T)
res.quad$log2FC_HFDvsControl <- results(dds.quad, name="DietHigh.Fat.Diet")$log2FoldChange
res.quad$lfcSE_HFDvsControl <- results(dds.quad, name="DietHigh.Fat.Diet")$lfcSE

res.quad$ensembl_gene_id <- as.character(lapply(strsplit(rownames(res.quad), "\\."), "[[", 1))

annotated.res.quad <- merge(as.data.frame(res.quad), 
                          annotation, 
                          by='ensembl_gene_id',
                          all.x=T)
kable(head( annotated.res.quad[order(annotated.res.quad$padj),],10), caption="Top Hits for Effects of Diet")
quad_diet_results_file <- 'DESeq Results for Effects of Diet on Quadriceps.csv'
write.csv(annotated.res.quad, quad_diet_results_file)
```

```{r deseq-MA-plot-quad-diet, fig.cap="MA Plot for Effects of Diet Status on Adipose Tissue"}
plotMA(res.quad, main="Muscle, Effects of Diet", ylim=c(-10,10), las=1)
```

We identified `r table(res.quad$padj < 0.05)['TRUE']` differentially expressed genes in quadriceps, out of a total of `r dim(res.quad)[1]` genes tested.  Of these significantly differentially expressed genes, `r table(res.quad$padj < 0.05, res.quad$log2FoldChange>0)['TRUE','TRUE']` were upregulated and `r table(res.quad$padj < 0.05, res.quad$log2FoldChange<0)['TRUE','TRUE']` were downregulated.


# Session Information

```{r session-info}
sessionInfo()
```
