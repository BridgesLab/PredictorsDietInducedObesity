
---
title: "Barplot Analysis of Juvenile HFD Study"
author: "Dave Bridges"
date: "August 13, 2015"
output:
  html_document:
    keep_md: true
---

```{r global_options, include=FALSE}
library(knitr)
opts_chunk$set(fig.path='figures/',
               echo=FALSE, warning=FALSE, message=FALSE,dev=c('png'))
options(digits=3, scipen=8)
```

Used analysed DESeq results.  This script was most recently run on `r date()`.

```{r file-input}
filename <- "Normalized Counts.csv"
deseq.filename.wat <- "DESeq Results for Effects of Diet on WAT.csv"
deseq.filename.quad <- "DESeq Results for Effects of Diet on Quadriceps.csv"
mapping.filename <- "../sample-mapping.csv"
annotation.filename <- "ENSEMBL Annotation.csv"
#read in the file
normalized.data <- read.csv(filename, row.names='X')
deseq.data.wat <- read.csv(deseq.filename.wat)
deseq.data.quad <- read.csv(deseq.filename.quad)
mapping <- read.csv(mapping.filename)
mapping$samplename <- paste("sample", mapping$sample.., sep="")
mapping$Diet <- relevel(mapping$Diet, ref="Control Diet")
annotation <- read.csv(annotation.filename, row.names="X")

colnames(normalized.data) <- gsub("X", "", colnames(normalized.data))
colnames(normalized.data) <- gsub("\\.", "-", colnames(normalized.data))
```

This script uses the DESeq files `r deseq.filename.wat` and the mapping file `r mapping.filename`.  It uses the annotation data found in `r annotation.filename`.  The normalized counts are found in `r filename`.

# Adipocytes

```{r adipose-barplots}
#get columns for adipose data
adipose.normalized.data <- normalized.data[,levels(droplevels(subset(mapping, Tissue=="eWAT")$SampleID))]
#remove decimal from gene name
adipose.normalized.data$ensembl_gene_id <- as.character(lapply(strsplit(rownames(adipose.normalized.data), "\\."), "[[", 1))

rpkm.data <- merge(adipose.normalized.data, annotation, by='ensembl_gene_id') 
rpkm.data.unique <- rpkm.data[!duplicated(rpkm.data$external_gene_name),]

rownames(rpkm.data.unique) <- rpkm.data.unique$external_gene_name
rpkm.data.unique <- rpkm.data.unique[,-1]
library(tidyr)
library(dplyr)
#set genes for single barplots
goi <- c("Retn","Pparg","Lep","Hsd11b1","Pnpla2","Tbc1d9b","Irf4","Clk4","Slc1a3","Ap2s1","Rer1","Ywhae","Eif4ebp3","Hsd11b1")
GR_activator <- c("Ncoa1", "Ncoa2", "Ncoa3")

#get a table of just the genes of interest
get_goi_data <- function (data, goi) {
  goi.data <- data[goi,]
  return(goi.data)
}

#genes.of.interest.data <- rpkm.data.unique[genes.of.interest,]
#put the data in long format
get_long_format <- function(genes.of.interest.data){
  genes.of.interest.long <- 
    genes.of.interest.data %>%
    select(-gene_biotype) %>%
    gather(SampleID, expression, -external_gene_name)
  goi.long <- merge(mapping, genes.of.interest.long, by="SampleID")
  
  goi.long <- 
    goi.long %>%
    group_by(external_gene_name, Feeding,Diet) %>%
    summarize(Average = mean(expression),
              SE = sd(expression)/sqrt(length(expression)))
  
  return(goi.long)
}
goi.dat <- get_goi_data(rpkm.data.unique, GR_activator)
goi.long.cal.wat <- get_long_format(goi.dat)

```


# Quadriceps

```{r quadriceps-barplots}
#get columns for adipose data
quad.normalized.data <- normalized.data[,levels(droplevels(subset(mapping, Tissue=="Quadriceps")$SampleID))]
#remove decimal from gene name
quad.normalized.data$ensembl_gene_id <- as.character(lapply(strsplit(rownames(quad.normalized.data), "\\."), "[[", 1))

rpkm.data.quad <- merge(quad.normalized.data, annotation, by='ensembl_gene_id') 
rpkm.data.unique.quad <- rpkm.data.quad[!duplicated(rpkm.data.quad$external_gene_name),]

rownames(rpkm.data.unique.quad) <- rpkm.data.unique.quad$external_gene_name
rpkm.data.unique.quad <- rpkm.data.unique.quad[,-1]

#get a table of just the genes of interest
goi.data.quad <- get_goi_data(rpkm.data.unique.quad, GR_activator)
#put the data in long format
goi.long.cal.quad <- get_long_format(goi.data.quad)

```


Drew bargraphs for *`r paste(GR_activator, collapse=", ")`*.

```{r barplots}
library(ggplot2)
draw_barplot<- function(goi.long.wat, goi.long.quad, genes.of.interest){
    for (gene in genes.of.interest) {
      gene.data <- goi.long.wat[goi.long.wat$external_gene_name==gene,]
      gene.data.quad <- goi.long.quad[goi.long.quad$external_gene_name==gene,]
      
      p <- ggplot(gene.data, aes(x=Diet,y=Average,fill=Feeding))
      q <- ggplot(gene.data.quad, aes(x=Diet,y=Average,fill=Feeding))
      
      dodge <- position_dodge(width=0.9)
      p + geom_bar(position=dodge, stat="identity") + geom_errorbar(aes(ymin=Average-SE, ymax=Average+SE), position=dodge, width=0.1) + 
       xlab("") + ylab("mRNA Expression (RPKM)")+ theme_bw() + ggtitle(paste("eWAT", gene)) + theme(panel.grid.minor = element_blank()) + theme(panel.grid.major = element_blank()) + theme(panel.border=element_blank()) + scale_x_discrete(labels=gene.data$Diet) + theme(axis.line = element_line(color = 'black'))+scale_colour_grey(start = 0.5, end = .9)
    ggsave(filename=paste('figures/barplots/Adipose-',gene,' - barplot-HTSeq.pdf',sep=""))
    
      q + geom_bar(position=dodge, stat="identity") + geom_errorbar(aes(ymin=Average-SE, ymax=Average+SE), position=dodge, width=0.1) + 
       xlab("") + ylab("mRNA Expression (RPKM)")+ theme_bw() + ggtitle(paste("Quadriceps", gene)) + 
        theme(panel.grid.minor = element_blank()) + 
        theme(panel.grid.major = element_blank()) + 
        theme(panel.border=element_blank()) + 
        scale_x_discrete(labels=gene.data$Diet) + 
        theme(axis.line = element_line(color = 'black'))+scale_colour_grey(start = 0.5, end = .9)
     ggsave(filename=paste('figures/barplots/Quadriceps-',gene,' - barplot-HTSeq.pdf',sep=""))
    
  }
}

draw_barplot(goi.long.cal.wat, goi.long.cal.quad, GR_activator)

```

Session Information
---------------------

```{r session-information}
sessionInfo()
```
