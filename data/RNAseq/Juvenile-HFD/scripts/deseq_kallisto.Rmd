---
title: "DESeq Analysis"
author: "Dave Bridges"
date: "August 2, 2015"
output:
  html_document:
    keep_md: true
---


```{r global_options, include=FALSE}
library(knitr)
opts_chunk$set(fig.path='figures/',
               echo=FALSE, warning=FALSE, message=FALSE,dev=c('png','pdf'))
options(digits=3, scipen=8)
```

This script performs the DESeq analyses on the Juvenile HFD studies.  This script was most recently run on `r date()`.  This uses the input data from the kallisto runs.

```{r data-entry-kallisto}
input_folder <- '../kallisto/kallisto_output'
sample.table_file <- '../sample-mapping.csv'
sample.table <- read.csv(sample.table_file)
sample.table$Barcode <- paste(sample.table$Barcode, "counts.txt", sep="-")
rownames(sample.table) <- as.character(lapply(strsplit(sample.table$Barcode, "-"), "[[",1))

annotation_file <- 'ENSEMBL Annotation - Transcripts.csv'
annotation <- read.csv(annotation_file)

#iterate over tsv files to make a table of the estimated counts and of the tpm
for (file in dir(file.path(input_folder))) {
  filename <- paste(paste(input_folder, file, sep="/"), "abundance.tsv", sep="/")
  temp <- read.table(filename, header=T)
  if ( !(exists('est.counts.table')) ) {
    est.counts.table <- data.frame(temp$est_counts)
    tpm.counts.table <- data.frame(temp$tpm)
  }
  else
     est.counts.table <- cbind(est.counts.table, temp$est_counts)
     tpm.counts.table <- cbind(tpm.counts.table, temp$tpm)
}
colnames(est.counts.table) <- dir(file.path(input_folder))
colnames(tpm.counts.table) <- dir(file.path(input_folder))
rownames(est.counts.table) <- as.character(lapply(strsplit(as.character(temp$target_id), "\\|"), "[[", 1))
rownames(tpm.counts.table) <- as.character(lapply(strsplit(as.character(temp$target_id), "\\|"), "[[", 1))

tpm.counts.file <- 'TPM Table.csv'
est.counts.file <- 'Estimated Counts.csv'

write.csv(tpm.counts.table, tpm.counts.file)
write.csv(est.counts.table, est.counts.file)

#reorder counts table to match sample table
est.counts.table <- est.counts.table[,rownames(sample.table)]
#make them into integers
for (col in colnames(est.counts.table)) {
  est.counts.table[,col] <- as.integer(est.counts.table[,col])
}
```

The counts data, derived from HTSeq are located in `r input_folder`.  The sample mapping file is located in `r sample.table_file`.  The annotations are from the file `r annotation_file`.  The files are written out as `r tpm.counts.file` and `r est.counts.file`.

```{r deseq-kallisto}
library(DESeq2)
#for sampleTable each row describes one sample. The first column is the sample name, the second column the file name of the count file generated by htseq-count, and the remaining columns are sample metadata which will be stored in colData
dds.overall <- DESeqDataSetFromMatrix(colData = sample.table,
                                       countData = est.counts.table, 
                                       design= ~ Tissue * Feeding * Diet)
library(BiocParallel)
register(MulticoreParam(8))
dds.overall <- DESeq(dds.overall, parallel=T, betaPrior = F)
res.overall <- results(dds.overall, parallel=T)
```

# Overall Analysis

The first model was a completely interacting model in which tissue, feeding state and diet were all able to interact.

```{r deseq-MA-plot-overall-kallisto, fig.cap="MA Plot for Overall Model"}
plotMA(res.overall, main="DESeq2", ylim=c(-4,4))
```

```{r deseq-PCA-plot-overall-kallisto, fig.cap="PCA Plot for Overall Model"}
rld.overall <- rlog(dds.overall)
plotPCA(rld.overall, intgroup=c("Tissue", "Feeding","Diet"))
distsRL <- dist(t(assay(rld.overall)))
```

```{r deseq-similarity-matrix-kallisto, fig.cap="Similarity Matrix for All Samples"}
library(gplots)
mat <- as.matrix(distsRL)
rownames(mat) <- colnames(mat) <- rownames(colData(dds.overall))
hc <- hclust(distsRL)
heatmap.2(mat, Rowv=as.dendrogram(hc),
symm=TRUE, trace="none")
```

# Adipose Tissue

The adipose tissue samples are all eWAT samples

## Effects of Feeding State

This model used only the adipose tissue data, and tested for changes related to the feeding state.

```{r wat-feeding-kallisto}
#subsettted the sample tables and counts tables
sample.table.wat <- subset(sample.table, Tissue=="eWAT")
est.counts.table.wat <- est.counts.table[,rownames(sample.table.wat)]
sample.table.quad <- subset(sample.table, Tissue=="Quadriceps")
est.counts.table.quad <- est.counts.table[,rownames(sample.table.quad)]

dds.wat.feeding <- DESeqDataSetFromMatrix(colData = sample.table.wat,
                                       countData = est.counts.table.wat,  
                                       design= ~ Feeding)

dds.wat.feeding <- DESeq(dds.wat.feeding, parallel=T, betaPrior = F)
res.wat.feeding <- results(dds.wat.feeding, parallel=T)
res.wat.feeding$ensembl_transcript_id <- as.character(lapply(strsplit(rownames(res.wat.feeding), "\\."), "[[", 1))

annotated.res.wat.feeding <- merge(as.data.frame(res.wat.feeding), 
                          annotation, 
                          by='ensembl_transcript_id',
                          all.x=T)
kable(head( annotated.res.wat.feeding[order(annotated.res.wat.feeding$padj),],5), caption="Top Hits for Effects of Feeding")
wat_feeding_results_file <- 'DESeq Results for Effects of Feeding on WAT - Kalllisto.csv'
write.csv(annotated.res.wat.feeding, wat_feeding_results_file)
```

```{r deseq-MA-plot-wat-feeding-kallisto, fig.cap="MA Plot for Effects of Feeding Status on Adipose Tissue"}
plotMA(res.wat.feeding, main="Adipose, Effects of Feeding", ylim=c(-4,4))
```

We identified `r table(res.wat.feeding$padj < 0.05)['TRUE']` differentially expressed transcripts in adipose tissue, out of a total of `r dim(res.wat.feeding)[1]` transcripts tested.  Of these significantly differentially expressed transcripts, `r table(res.wat.feeding$padj < 0.05, res.wat.feeding$log2FoldChange>0)['TRUE','TRUE']` were upregulated and `r table(res.wat.feeding$padj < 0.05, res.wat.feeding$log2FoldChange<0)['TRUE','TRUE']` were downregulated.

## Effects of Diet Overall

```{r wat-diet-main-kallisto}
dds.wat <- DESeqDataSetFromMatrix(colData = sample.table.wat,
                                  countData = est.counts.table.wat, 
                                  design = ~ Feeding + Diet)

dds.wat <- DESeq(dds.wat,   test  = "LRT",
  full = ~  Feeding + Diet,
  reduced = ~ Feeding,
  parallel= T)

res.wat <- results(dds.wat, parallel=T)

res.wat$ensembl_transcript_id <- as.character(lapply(strsplit(rownames(res.wat), "\\."), "[[", 1))

annotated.res.wat <- merge(as.data.frame(res.wat), 
                          annotation, 
                          by='ensembl_transcript_id',
                          all.x=T)
kable(head( annotated.res.wat[order(annotated.res.wat$padj),],10), caption="Top Hits for Effects of Diet, Ignoring Feeding")
wat_diet_results_file <- 'DESeq Results for Main Effects of Diet on WAT - Kalllisto.csv'
write.csv(annotated.res.wat, wat_diet_results_file)
```

```{r deseq-MA-plot-wat-diet-main-kallisto, fig.cap="MA Plot for Main Effects of Diet Status on Adipose Tissue"}
plotMA(res.wat, main="Adipose, Effects of Diet", ylim=c(-10,10), las=1)
```

We identified `r table(res.wat$padj < 0.05)['TRUE']` differentially expressed transcripts, out of a total of `r dim(res.wat)[1]` transcripts tested.  

## Effects of Diet with an Interaction

```{r wat-diet-interaction-kallisto}
dds.wat <- DESeqDataSetFromMatrix(colData = sample.table.wat,
                                  countData = est.counts.table.wat,
                                  design = ~ Feeding + Diet + Feeding:Diet)

dds.wat <- DESeq(dds.wat,   test  = "LRT",
  full = ~  Feeding + Diet + Feeding:Diet,
  reduced = ~ Feeding,
  parallel= T)

res.wat <- results(dds.wat, parallel=T)
res.wat$log2FC_HFDvsControl <- results(dds.wat, name="Diet_High.Fat.Diet_vs_Control.Diet")$log2FoldChange
res.wat$lfcSE_HFDvsControl <- results(dds.wat, name="Diet_High.Fat.Diet_vs_Control.Diet")$lfcSE

res.wat$ensembl_transcript_id <- as.character(lapply(strsplit(rownames(res.wat), "\\."), "[[", 1))

annotated.res.wat <- merge(as.data.frame(res.wat), 
                          annotation, 
                          by='ensembl_transcript_id',
                          all.x=T)
kable(head( annotated.res.wat[order(annotated.res.wat$padj),],10), caption="Top Hits for Effects of Diet")
wat_diet_results_file <- 'DESeq Results for Effects of Diet with an Interaction in WAT - Kalllisto.csv'
write.csv(annotated.res.wat, wat_diet_results_file)
```

```{r deseq-MA-plot-wat-diet-interaction-kallisto, fig.cap="MA Plot for Effects of Diet Status on Adipose Tissue"}
plotMA(res.wat, main="Adipose, Effects of Diet with an Interaction", ylim=c(-10,10), las=1)
```

We identified `r table(res.wat$padj < 0.05)['TRUE']` differentially expressed transcripts, out of a total of `r dim(res.wat)[1]` transcripts tested.  Of these significantly differentially expressed transcripts, `r table(res.wat$padj < 0.05, res.wat$log2FoldChange>0)['TRUE','TRUE']` were upregulated and `r table(res.wat$padj < 0.05, res.wat$log2FoldChange<0)['TRUE','TRUE']` were downregulated.

# Muscle Tissue

The muscle tissue samples are all quadriceps samples

## Effects of Feeding State

This model used only the quadriceps tissue data, and tested for changes related to the feeding state.

```{r quad-feeding-kallisto}
dds.quad.feeding <- DESeqDataSetFromMatrix(colData = sample.table.quad,
                                       countData = est.counts.table.quad,  
                                       design= ~ Feeding)

dds.quad.feeding <- DESeq(dds.quad.feeding, parallel=T, betaPrior = F)
res.quad.feeding <- results(dds.quad.feeding, parallel=T)
res.quad.feeding$ensembl_transcript_id <- as.character(lapply(strsplit(rownames(res.quad.feeding), "\\."), "[[", 1))

annotated.res.quad.feeding <- merge(as.data.frame(res.quad.feeding), 
                          annotation, 
                          by='ensembl_transcript_id',
                          all.x=T)
kable(head( annotated.res.quad.feeding[order(annotated.res.quad.feeding$padj),],5), caption="Top Hits for Effects of Feeding")
quad_feeding_results_file <- 'DESeq Results for Effects of Feeding on Quadriceps - Kalllisto.csv'
write.csv(annotated.res.quad.feeding, quad_feeding_results_file)
```

```{r deseq-MA-plot-quad-feeding-kallisto, fig.cap="MA Plot for Effects of Feeding Status on Muscle Tissue"}
plotMA(res.quad.feeding, main="Muscle, Effects of Feeding", ylim=c(-4,4))
```

We identified `r table(res.quad.feeding$padj < 0.05)['TRUE']` differentially expressed transcripts in muscle tissue, out of a total of `r dim(res.quad.feeding)[1]` transcripts tested.  Of these significantly differentially expressed transcripts, `r table(res.quad.feeding$padj < 0.05, res.quad.feeding$log2FoldChange>0)['TRUE','TRUE']` were upregulated and `r table(res.quad.feeding$padj < 0.05, res.quad.feeding$log2FoldChange<0)['TRUE','TRUE']` were downregulated.

## Effects of Diet 

```{r quad-diet-kallisto}
dds.quad <- DESeqDataSetFromMatrix(colData = sample.table.quad,
                                   countData = est.counts.table.quad, 
                                   design = ~ Feeding + Diet + Feeding:Diet)

dds.quad <- DESeq(dds.quad,   test  = "LRT",
  full = ~  Feeding + Diet + Feeding:Diet,
  reduced = ~ Feeding,
  parallel= T)
res.quad <- results(dds.quad, parallel=T)
res.quad$log2FC_HFDvsControl <- results(dds.quad, name="Diet_High.Fat.Diet_vs_Control.Diet")$log2FoldChange
res.quad$lfcSE_HFDvsControl <- results(dds.quad, name="Diet_High.Fat.Diet_vs_Control.Diet")$lfcSE

res.quad$ensembl_transcript_id <- as.character(lapply(strsplit(rownames(res.quad), "\\."), "[[", 1))

annotated.res.quad <- merge(as.data.frame(res.quad), 
                          annotation, 
                          by='ensembl_transcript_id',
                          all.x=T)
kable(head( annotated.res.quad[order(annotated.res.quad$padj),],10), caption="Top Hits for Effects of Diet")
quad_diet_results_file <- 'DESeq Results for Effects of Diet on Quadriceps - Kalllisto.csv'
write.csv(annotated.res.quad, quad_diet_results_file)
```

```{r deseq-MA-plot-quad-diet-kallisto, fig.cap="MA Plot for Effects of Diet Status on Adipose Tissue"}
plotMA(res.quad, main="Muscle, Effects of Diet", ylim=c(-10,10), las=1)
```

We identified `r table(res.quad$padj < 0.05)['TRUE']` differentially expressed transcripts in quadriceps, out of a total of `r dim(res.quad)[1]` transcripts tested.  Of these significantly differentially expressed transcripts, `r table(res.quad$padj < 0.05, res.quad$log2FoldChange>0)['TRUE','TRUE']` were upregulated and `r table(res.quad$padj < 0.05, res.quad$log2FoldChange<0)['TRUE','TRUE']` were downregulated.

## Effects of Diet with an Interaction

```{r quad-diet-interaction-kallisto}
dds.quad <- DESeqDataSetFromMatrix(colData = sample.table.quad,
                                  countData = est.counts.table.quad,
                                  design = ~ Feeding + Diet + Feeding:Diet)

dds.quad <- DESeq(dds.quad,   test  = "LRT",
  full = ~  Feeding + Diet + Feeding:Diet,
  reduced = ~ Feeding,
  parallel= T)

res.quad <- results(dds.quad, parallel=T)
res.quad$log2FC_HFDvsControl <- results(dds.quad, name="Diet_High.Fat.Diet_vs_Control.Diet")$log2FoldChange
res.quad$lfcSE_HFDvsControl <- results(dds.quad, name="Diet_High.Fat.Diet_vs_Control.Diet")$lfcSE

res.quad$ensembl_transcript_id <- as.character(lapply(strsplit(rownames(res.quad), "\\."), "[[", 1))

annotated.res.quad <- merge(as.data.frame(res.quad), 
                          annotation, 
                          by='ensembl_transcript_id',
                          all.x=T)
kable(head( annotated.res.quad[order(annotated.res.quad$padj),],10), caption="Top Hits for Effects of Diet with An Interaction")
quad_diet_results_file <- 'DESeq Results for Effects of Diet with an Interaction in Quariceps - Kalllisto.csv'
write.csv(annotated.res.quad, quad_diet_results_file)
```

```{r deseq-MA-plot-quad-diet-interaction-kallisto, fig.cap="MA Plot for Effects of Diet Status on Quadriceps Tissue"}
plotMA(res.quad, main="Quadriceps, Effects of Diet with an Interaction", ylim=c(-10,10), las=1)
```

We identified `r table(res.quad$padj < 0.05)['TRUE']` differentially expressed transcripts, out of a total of `r dim(res.quad)[1]` transcripts tested.  Of these significantly differentially expressed transcripts, `r table(res.quad$padj < 0.05, res.quad$log2FoldChange>0)['TRUE','TRUE']` were upregulated and `r table(res.quad$padj < 0.05, res.quad$log2FoldChange<0)['TRUE','TRUE']` were downregulated.

# Session Information

```{r session-info}
sessionInfo()
```
