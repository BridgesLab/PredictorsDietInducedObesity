---
title: "Food_intake"
author: "Quynh Tran"
date: "November 30, 2015"
output: html_document
---

This script was most recently run on `r date()`. 

```{r read_food_data_corhot7_data, message=FALSE, echo=FALSE, warning=FALSE}
dir <- "./data/processed/Feeding_data/Cohort7/"
#data <- read.csv(file=paste(dir,"Feeding_1745.csv", sep=""))
cohort7 <- data.frame(matrix(ncol = 10, nrow = 0))
####
##Make a function that read the food intake from each animal to a dataframe
##Parameters: directory - the directory contains all the food intake files
##           start_ID - the smallest animal ID 
##           stop_ID - the biggest animal ID. We assume that animal_IDs are
##all consecutive numbers.
##           eliminate_ID - IDs of non-existing animals
##           out_data - the data that save the combined food intake
####
read.input <- function(directory, start_ID, stop_ID, eliminate_ID, out_data){
  for (i in start_ID:stop_ID){
    if (!(i %in% eliminate_ID)){
      feeding_file <- paste(directory, "Feeding_", i, ".csv", sep="")
      #print(feeding_file)
      data <- read.csv(file=feeding_file)
      names(data)[2] <- "Sample"
      names(data)[4] <- "Light_Dark"
      names(data)[7] <- "Duration"
      names(data)[8] <- "Weight"
      names(data)[9] <- "Accumulated"
      names(data)[10] <- "Animal_ID"
      data$Animal_ID <- i
      names(out_data) <- names(data)
      out_data <- rbind(out_data, data)
    }
  }
  return(out_data)
}

cohort7 <-read.input(dir, 1745, 1769, 1764, cohort7)

cohort7$Animal_ID <- factor(cohort7$Animal_ID)
cohort7$Light_Dark <- factor(cohort7$Light_Dark)
#remove negative numbers and those that are more than 0.2 g of food. Mice won't eat more than that each time.
cohort7 <- cohort7[cohort7$Weight<0.2 & cohort7$Weight>0,]
#remove any duration that is more than 300
cohort7 <- cohort7[cohort7$Duration<300,]
#remove all the measurement after interval 129. Those after 129 may be from a different experiment.
cohort7 <- cohort7[cohort7$Interval <= 129,]

```

Analyze the food intake habit separate in Light and Dark
---------
```{r analyze_ligh_dark_cohort7, echo=FALSE, message=FALSE, warning=FALSE}
se <- function(x) sd(x)/sqrt(length(x))
library(ggplot2)
library(plyr)
library(dplyr)
#for each animal compute the number of feedings, feeding duration in light and dark
cohort7_summary <-
  cohort7 %>%
  group_by(Animal_ID, Light_Dark) %>%
  summarise(
    sum_weight = sum(Weight),
    mean_weight = mean(Weight),
    se_weight = se(Weight),
    sum_duration = sum(Duration),
    mean_duration = mean(Duration),
    se_duration = se(Duration),
    num_feed = length(Weight),
    food_per_sec = sum_weight/sum_duration
    #weight.shapiro = shapiro.test(Weight)$p.value
    )
cohort7_summary <- cohort7_summary[!is.na(cohort7_summary$Light_Dark), ]

cohort7$Interval <- as.factor(cohort7$Interval)
ggplot(data=cohort7[cohort7$Animal_ID=="1767",], aes(x=Date.Time, y=Weight, group=Animal_ID, colour=Animal_ID)) +
  geom_point() + geom_line()+         
  xlab("Interval") +
  ylab("Food (g)")


#Number of feedings for each mouse
ggplot(data=cohort7_summary, aes(x=Animal_ID, y=num_feed, colour=Animal_ID)) +
  geom_point(data=cohort7_summary, aes(fill=Animal_ID)) +         
  facet_grid(.~Light_Dark) +
  ggtitle("Feeding habit")+
  xlab("Animal_ID") +
  ylab("Number of feedings")
ggsave("./figures/Cohor7_Number_of_feedings.pdf")

#Avg Duration per feeding
ggplot(data=cohort7_summary, aes(x=Animal_ID, y=mean_duration, colour=Animal_ID)) +
  geom_bar(position=position_dodge(), aes(fill=Animal_ID),stat="identity") +  
  geom_errorbar(aes(ymin=mean_duration-se_duration, ymax=mean_duration+se_duration), width=0.25, position=position_dodge(.9)) +
  facet_grid(.~Light_Dark) +
  ggtitle("Cohort7 Feeding habit")+
  xlab("Animal_ID") +
  ylab("Avg duration per feeding (s)")
ggsave("./figures/Cohor7_duration_per_feeding.pdf")

ggplot(cohort7_summary, aes(x=Animal_ID, y=sum_weight, group=Animal_ID, colour=Animal_ID)) + 
  geom_point()+
  facet_grid(Light_Dark~.)+
  ggtitle("Cohort7 total food intake")+
  xlab("Animal ID")+
  ylab("Food (g)")
ggsave("./figures/Cohor7_total_food_intake_in_each_animal.pdf")
```

Analysis for each animal per day
-----------
```{r analysis_per_animal}
library(lubridate)
cohort7$Date.Time <- mdy_hms(cohort7$Date.Time)
numday <- as.period(interval(first(cohort7$Date.Time),last(cohort7$Date.Time)), units="days")
day.stamp <- as.POSIXct(rep(NA, day(numday)), tz="UTC")
#calculate the time stamp for each next day.
for (d in 1:day(numday)){
  day.stamp[d] = first(cohort7$Date.Time) + days(d)
  mdy_hms(day.stamp)
}
cohort7$Day <- NULL
for (row in rownames(cohort7)) {
  if (cohort7[row,]$Date.Time)< (first(cohort7$Date.Time)+days(1)){cohort7[row, 'Day'] <- '1'
                                                                   }
  else if (cohort7[row,]$Date.Time)>(first(cohort7$Date.Time) + days(1)) & cohort7[row,]$Date.Time)< (first(cohort7$Date.Time) + days(2))){
    cohort7[row,'Day'] <- '2'
  }
  else if (cohort7[row,]$Date.Time)>(first(cohort7$Date.Time) + days(2)) & cohort7[row,]$Date.Time)< (first(cohort7$Date.Time) + days(3)))
    cohort7[row,'Day'] <- '2'
}

for (row in rownames(cohort7)) {
  num_day <- as.period(interval(first(cohort7$Date.Time),cohort7[row,]$Date.Time), units="days")
  print(day(num_day))
  cohort7[row, 'Day'] = day(num_day)
}



#calculate the amount of food intake for each day
cohort7_each_animal_by_day <-
  cohort7 %>%
  group_by(Animal_ID, substring(Date.Time,0, 11)) %>%
  summarise(
    sum_weight = sum(Weight), #get the food for each day
    #num_day = length(Animal_ID) -1,
    #food_per_day = sum(sum_weight)/num_day, #get the food/day
    #se_weight = se(sum_weight),
    sum_duration = sum(Duration),
    mean_duration = mean(Duration),
    se_duration = se(Duration),
    num_feed = length(Weight)
    #food_per_sec = sum_weight/sum_duration
    )
#Is the amount of food intake per day the same in all animals?
kruskal.test(sum_weight ~ Animal_ID, data=cohort7_each_animal_by_day)


#calculate the amount of food intake for each animal from the each day statistics
cohort7_each_animal <-
  cohort7_each_animal_by_day %>%
  group_by(Animal_ID) %>%
  summarise(
    cum_food = sum(sum_weight),
    mean_food = mean(sum_weight),
    se_food = se(sum_weight),
    num_day = length(Animal_ID)-1,
    mean_duration = mean(sum_duration),
    se_duration = se(sum_duration),
    num_feed = sum(num_feed),
    food.day = cum_food/num_day
    #weight.shapiro = shapiro.test(sum_weight)$p.value
  )


ggplot(data=cohort7_each_animal, aes(x=Animal_ID, y=mean_food, colour=Animal_ID)) +
  geom_bar(position=position_dodge(), aes(fill=Animal_ID),stat="identity") +  
  geom_errorbar(aes(ymin=mean_food-se_food, ymax=mean_food+se_food), width=0.25, position=position_dodge(.9)) +
  ggtitle("Cohort7 Food intake per day")+
  xlab("Animal_ID") +
  ylab("Food (g/day)")
ggsave("./figures/Cohor7_food_intake_per_day.pdf")

food_dark <- cohort7_summary[cohort7_summary$Light_Dark=="Dark",]
food_light <- cohort7_summary[cohort7_summary$Light_Dark=="Light",]
dark.shapiro <- shapiro.test(food_dark$sum_weight)

wilcox.test(food_dark$sum_weight, food_light$sum_weight, alternative="greater", conf.int=T)

boxplot(sum_weight~Light_Dark, data=cohort7_summary)
boxplot(sum_duration~Light_Dark, data=cohort7_summary)
wilcox.test(sum_weight ~ Light_Dark, data=cohort7_summary, alternative="greater", conf.int=T)

wilcox.test(Duration ~ Light_Dark, data=cohort7, alternative="greater")

#compare the mean food intake across all mice.
kruskal.test(mean_weight ~ Animal_ID, data=food_dark)
kruskal.test(mean_weight ~ Animal_ID, data=food_light)

```

There is no difference in the food intake across all animals  either in the dark (`r kruskal.test(mean_weight ~ Animal_ID, data=food_dark)$p.value`) or light cycle (`r kruskal.test(mean_weight ~ Animal_ID, data=food_light)$p.value`). It appears that mice consumed more food in the dark than in the light, Wilcoxon's p-value is `wilcox.test(sum_weight ~ Light_Dark, data=cohort7_summary, alternative="greater")$p.value`.

Analysis adjusting for LBM, BW, or fat mass
-----
```{r food_intake_per_LBM}
body_comp_7_file <- "./data/processed/body_composition_cohort7.csv"
body_comp_7 <- read.csv(body_comp_7_file)
food_LBM7 <- merge(body_comp_7, cohort7_each_animal, by.x="animal.MouseID", by.y="Animal_ID")

food_per_LBM7 <-
  food_LBM7 %>%
  group_by(animal.MouseID, Fasting_stat) %>%
  summarise(
    food.LBM = cum_food/Lean,
    food.BW = cum_food/Weight,
    food.FM = cum_food/Fat,
    food.LBM.day = (cum_food/Lean)/num_day,
    food.BW.day = (cum_food/Weight)/num_day,
    food.FM.day = food.FM/num_day,
    food.day = food.day
  )

food_per_LBM7$animal.MouseID <- as.factor(food_per_LBM7$animal.MouseID)
food_per_LBM7$Fasting_stat <- relevel(as.factor(food_per_LBM7$Fasting_stat), ref='Pre_fasting')

ggplot(data=food_per_LBM7, aes(x=animal.MouseID, y=food.LBM.day, colour=animal.MouseID)) +
  geom_bar(position=position_dodge(), aes(fill=animal.MouseID),stat="identity") +  
  facet_grid(.~Fasting_stat)+
  ggtitle("Cohort7 Food intake per LBM per day")+
  xlab("Animal_ID") +
  ylab("Food intake (g/g LBM per day)")

ggplot(data=food_per_LBM7, aes(x=animal.MouseID, y=food.FM.day, colour=animal.MouseID)) +
  geom_bar(position=position_dodge(), aes(fill=animal.MouseID),stat="identity") +  
  facet_grid(.~Fasting_stat)+
  ggtitle("Cohort7 Food intake per g of fat mass per day")+
  xlab("Animal_ID") +
  ylab("Food intake (g/g fat mass per day)")


with(food_LBM7, plot(Lean,food.day, pch=19, las=1,
                            col=c('green','red','blue'),
                            xlab="Fat Free Mass (g)",
                            ylim=c(0,max(food.day)),
                            ylab="Daily Food Intake (g)"))
cor(food_LBM7$Lean, food_LBM7$food.day, method="kendall")
cor.test(food_LBM7$Lean, food_LBM7$food.day, method="kendall")

with(food_LBM7, plot(Fat,food.day, pch=19, las=1,
                            col=c('green','red','blue'),
                            xlab="Fat Mass (g)",
                            ylim=c(0,max(food.day)),
                            ylab="Daily Food Intake (g)"))
cor(food_LBM7$Fat, food_LBM7$food.day, method="kendall")
cor.test(food_LBM7$Fat, food_LBM7$food.day, method="kendall")
```


There is no correlation between the food intake before fasting and the amount of fat mass accumulated after HFD. The correlation is `r cor(food_LBM7$Fat, food_LBM7$food.day, method="kendall")` with the p-value of `r cor.test(food_LBM7$Fat, food_LBM7$food.day, method="kendall")$p.value`.


Analysis for cohort8
----------
```{r read_food_data_corhot8_data, message=FALSE, echo=FALSE, warning=FALSE}
dir8 <- "./data/processed/Feeding_data/Cohort8/"
cohort8 <- data.frame(matrix(ncol = 10, nrow = 0))
cohort8 <- read.input(dir8, 2098, 2128, c(2100,2110), cohort8)

cohort8$Animal_ID <- factor(cohort8$Animal_ID)
#remove negative numbers and those that are more than 0.2 g of food. Mice won't eat more than that each time.
cohort8 <- cohort8[cohort8$Weight<0.2 & cohort8$Weight>0,]

#cohort8 <- cohort8[cohort8$Interval <= 129,]

cohort8_summary <-
  cohort8 %>%
  group_by(Animal_ID, Light_Dark) %>%
  summarise(
    sum_weight = sum(Weight),
    mean_weight = mean(Weight),
    se_weight = se(Weight),
    sum_duration = sum(Duration),
    mean_duration = mean(Duration),
    se_duration = se(Duration),
    num_feed = length(Weight),
    food_per_sec = sum_weight/sum_duration
    #weight.shapiro = shapiro.test(Weight)$p.value
    )
cohort8_summary <- cohort8_summary[!is.na(cohort8_summary$Light_Dark), ]

#Number of feedings for each mouse
ggplot(data=cohort8_summary, aes(x=Animal_ID, y=num_feed, colour=Animal_ID)) +
  geom_point(data=cohort8_summary, aes(fill=Animal_ID)) +         
  facet_grid(.~Light_Dark) +
  ggtitle("Feeding habit")+
  xlab("Animal_ID") +
  ylab("Number of feedings")

#Avg Duration per feeding
ggplot(data=cohort8_summary, aes(x=Animal_ID, y=mean_duration, colour=Animal_ID)) +
  geom_bar(position=position_dodge(), aes(fill=Animal_ID),stat="identity") +  
  geom_errorbar(aes(ymin=mean_duration-se_duration, ymax=mean_duration+se_duration), width=0.25, position=position_dodge(.9)) +
  facet_grid(.~Light_Dark) +
  ggtitle("cohort8 Feeding habit")+
  xlab("Animal_ID") +
  ylab("Avg duration per feeding (s)")


ggplot(cohort8_summary, aes(x=Animal_ID, y=sum_weight, group=Animal_ID, colour=Animal_ID)) + 
  geom_point()+
  facet_grid(Light_Dark~.)+
  ggtitle("cohort8 total food intake")+
  xlab("Animal ID")+
  ylab("Food (g)")
```

Analysis for each animal per day cohort8
-----------
```{r analysis_per_animal}
#calculate the amount of food intake for each day
cohort8_each_animal_by_day <-
  cohort8 %>%
  group_by(Animal_ID, substring(Date.Time,0, 11)) %>%
  summarise(
    sum_weight = sum(Weight), #get the food for each day
    #num_day = length(Animal_ID) -1,
    #food_per_day = sum(sum_weight)/num_day, #get the food/day
    #se_weight = se(sum_weight),
    sum_duration = sum(Duration),
    mean_duration = mean(Duration),
    se_duration = se(Duration),
    num_feed = length(Weight)
    #food_per_sec = sum_weight/sum_duration
    )
#Is the amount of food intake per day the same in all animals?
kruskal.test(sum_weight ~ Animal_ID, data=cohort8_each_animal_by_day)

library(lubridate)

cohort8$Date.Time <- mdy_hms(cohort8$Date.Time)

for (row in rownames(feeding_data)) {
  if (hour(feeding_data[row,]$Date.Time)>7&hour(feeding_data[row,]$Date.Time)<19){
    feeding_data[row,'Dark.Light'] <- 'Light'
  }
  else
    feeding_data[row,'Dark.Light'] <- 'Dark'
}
feeding_data$Dark.Light <- as.factor(feeding_data$Dark.Light)


#calculate the amount of food intake for each animal from the each day statistics
cohort8_each_animal <-
  cohort8_each_animal_by_day %>%
  group_by(Animal_ID) %>%
  summarise(
    cum_food = sum(sum_weight),
    mean_food = mean(sum_weight),
    se_food = se(sum_weight),
    num_day = length(Animal_ID)-1,
    mean_duration = mean(sum_duration),
    se_duration = se(sum_duration),
    num_feed = sum(num_feed),
    food.day = cum_food/num_day
    #weight.shapiro = shapiro.test(sum_weight)$p.value
  )


ggplot(data=cohort8_each_animal, aes(x=Animal_ID, y=mean_food, colour=Animal_ID)) +
  geom_bar(position=position_dodge(), aes(fill=Animal_ID),stat="identity") +  
  geom_errorbar(aes(ymin=mean_food-se_food, ymax=mean_food+se_food), width=0.25, position=position_dodge(.9)) +
  ggtitle("cohort8 Food intake per day")+
  xlab("Animal_ID") +
  ylab("Food (g/day)")

food_dark8 <- cohort8_summary[cohort8_summary$Light_Dark=="Dark",]
food_light8 <- cohort8_summary[cohort8_summary$Light_Dark=="Light",]
dark.shapiro <- shapiro.test(food_dark$sum_weight)

wilcox.test(food_dark$sum_weight, food_light$sum_weight, alternative="greater")
boxplot(Weight~Light_Dark, data=cohort8)
boxplot(Duration~Light_Dark, data=cohort8)
wilcox.test(Weight ~ Light_Dark, data=cohort8, alternative="greater")
wilcox.test(Duration ~ Light_Dark, data=cohort8, alternative="greater")

#compare the mean food intake across all mice.
kruskal.test(mean_weight ~ Animal_ID, data=food_dark8)
kruskal.test(mean_weight ~ Animal_ID, data=food_light8)

```


  
Analysis of combining cohort7 and 8
--------
```{r}
combined_data <- 
```

Session Information
---------------------
```{r sessionInfo, echo=F}
sessionInfo()
```
